<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TecnoiT - Field Closing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
    <style>
        body { font-family: 'Roboto', sans-serif; -webkit-font-smoothing: antialiased; background-color: #f8fafc; }
        .touch-btn:active { transform: scale(0.98); }
        input, textarea, select { font-size: 16px !important; } /* Prevent iOS zoom */
        .modal-overlay { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">
    <!-- Use 100dvh for better mobile support -->
    <div id="root" class="h-[100dvh] flex flex-col max-w-2xl mx-auto shadow-2xl bg-white"></div>

    <script>
       const firebaseConfig = {
            apiKey: "AIzaSyCh47eM6oXz-vN-2iAZXbDtTIi0CvFe_wY",
            authDomain: "app-tecnoit.firebaseapp.com",
            projectId: "app-tecnoit",
            storageBucket: "app-tecnoit.firebasestorage.app",
            messagingSenderId: "675993906644",
            appId: "1:675993906644:web:90f5fdbbb852a5caa43a41",
            measurementId: "G-MLEH036DLK"
        };
    </script>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        const lucideReactUrl = "https://cdn.skypack.dev/lucide-react";
        let User, Lock, LogIn, PlusCircle, Camera, Mic, Box, Trash2, CheckCircle, XCircle, ChevronDown, Wifi, WifiOff, RefreshCw, Eye, EyeOff, Search, X;

        // Firebase is kept for potential future use or auth if needed, but the main logic is now Proxy-based
        const firebaseAppUrl = "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        const firebaseAuthUrl = "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        const firestoreUrl = "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        function AppWrapper() {
            const [libsLoaded, setLibsLoaded] = useState(false);
            useEffect(() => {
                Promise.all([import(lucideReactUrl), import(firebaseAppUrl), import(firebaseAuthUrl), import(firestoreUrl)])
                    .then(([lucide, app, auth, firestore]) => {
                        ({ User, Lock, LogIn, PlusCircle, Camera, Mic, Box, Trash2, CheckCircle, XCircle, ChevronDown, Wifi, WifiOff, RefreshCw, Eye, EyeOff, Search, X } = lucide);
                        window.firebase = { app, auth, firestore };
                        setLibsLoaded(true);
                    }).catch(error => console.error("Falha ao carregar as bibliotecas:", error));
            }, []);

            if (!libsLoaded) return <LoadingScreen message="Iniciando sistema..." />;
            return <App />;
        }

        const APP_VERSION = '1.1.0';

        function App() {
            const { initializeApp } = window.firebase.app;
            const { getAuth, onAuthStateChanged, signInAnonymously } = window.firebase.auth;
            const app = useMemo(() => initializeApp(firebaseConfig), []);
            const auth = useMemo(() => getAuth(app), [app]);

            // App State
            const [view, setView] = useState('login'); // login, dashboard, ticketDetail
            const [user, setUser] = useState(null); // Firebase User
            const [glpiSession, setGlpiSession] = useState(null); // { sessionToken, fullSessionData, glpiUrl }
            const [isLoading, setIsLoading] = useState(true);
            const [selectedTicketId, setSelectedTicketId] = useState(null);

            // Init Firebase Auth (Anonymous for simplicity as we use GLPI Auth)
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
                return () => unsubscribe();
            }, [auth]);

            // Check for saved GLPI Session on startup & Cache Busting
            useEffect(() => {
                const checkSession = async () => {
                   // Check Version to force refresh if needed
                   const savedVersion = localStorage.getItem('appVersion');
                   if (savedVersion !== APP_VERSION) {
                       console.log("New version detected. Clearing old session.");
                       localStorage.removeItem('glpiSessionData');
                       localStorage.setItem('appVersion', APP_VERSION);
                   }

                   const savedCreds = localStorage.getItem('glpiSessionData');
                   if (savedCreds) {
                       try {
                           const parsed = JSON.parse(savedCreds);
                           setGlpiSession(parsed);
                           setView('dashboard');
                       } catch (e) {
                           localStorage.removeItem('glpiSessionData');
                       }
                   }
                   setIsLoading(false);
                };
                if (user) checkSession();
            }, [user]);

            const handleLoginSuccess = (sessionData) => {
                setGlpiSession(sessionData);
                localStorage.setItem('glpiSessionData', JSON.stringify(sessionData));
                setView('dashboard');
            };

            const handleLogout = () => {
                setGlpiSession(null);
                localStorage.removeItem('glpiSessionData');
                setView('login');
            };

            if (isLoading) return <LoadingScreen message="Verificando sess√£o..." />;

            return (
                <div className="flex flex-col h-full bg-slate-50">
                     {view === 'login' && <LoginScreen onLogin={handleLoginSuccess} />}
                     {view === 'dashboard' && <Dashboard session={glpiSession} onNavigate={(v, id) => { if(id) setSelectedTicketId(id); setView(v); }} onLogout={handleLogout} />}
                     {view === 'ticketDetail' && <TicketDetail session={glpiSession} ticketId={selectedTicketId} onBack={() => setView('dashboard')} />}
                </div>
            );
        }

        const LoadingScreen = ({ message }) => (
             <div className="flex flex-col items-center justify-center h-full bg-slate-50">
                <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p className="text-lg font-medium text-slate-600 animate-pulse">{message}</p>
            </div>
        );

        // --- 1. LOGIN SIMPLIFICADO ---
        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(true);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            // Entity Selection State
            const [showEntitySelect, setShowEntitySelect] = useState(false);
            const [entities, setEntities] = useState([]);
            const [pendingSession, setPendingSession] = useState(null);
            const [selectedEntityId, setSelectedEntityId] = useState(null);

            useEffect(() => {
                const savedUser = localStorage.getItem('glpiUsername');
                if (savedUser) setUsername(savedUser);
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');

                try {
                    const glpiUrl = 'https://suporte.tecnoit.com.br';

                    const res = await fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/initSession', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ glpiUrl, username, password, get_full_session: true })
                    });

                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'Falha na autentica√ß√£o');

                    if (rememberMe) localStorage.setItem('glpiUsername', username);
                    else localStorage.removeItem('glpiUsername');

                    let fullSession = null;

                    // STRICT CHECK: Ensure glpimy_entities is present.
                    // If the "Fast Login" returns session but NO entities, we MUST fetch full session.
                    if (data.session && data.session.glpimy_entities) {
                        fullSession = data.session;
                    } else {
                        // Fallback to Full Fetch if entities are missing
                        const sessionRes = await fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/getFullSession', {
                            method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ glpiUrl, sessionToken: data.session_token })
                        });

                        if(!sessionRes.ok) throw new Error('Erro ao carregar perfil do usu√°rio');
                        fullSession = (await sessionRes.json()).session;
                    }

                    // Parse entities
                    const rawEntities = fullSession.glpimy_entities;
                    const parsedEntities = [];
                    // Handle recursive structure or simple array
                    if (Array.isArray(rawEntities)) {
                        rawEntities.forEach(e => parsedEntities.push({ id: e.id, name: e.completename || e.name }));
                    } else if (typeof rawEntities === 'object') {
                         // Iterate values
                         Object.values(rawEntities).forEach(e => {
                             if(typeof e === 'object') parsedEntities.push({ id: e.id, name: e.completename || e.name });
                             else parsedEntities.push({ id: e, name: e }); // Primitive?
                         });
                    }
                    parsedEntities.sort((a,b) => a.name.localeCompare(b.name));

                    if (parsedEntities.length > 1) {
                        setEntities(parsedEntities);
                        setPendingSession({ sessionToken: data.session_token, fullSessionData: fullSession, glpiUrl });
                        setShowEntitySelect(true);
                    } else {
                        onLogin({
                            sessionToken: data.session_token,
                            fullSessionData: fullSession,
                            glpiUrl
                        });
                    }

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const confirmEntitySelection = async () => {
                if (!selectedEntityId) return;
                setLoading(true);
                try {
                     const { sessionToken, glpiUrl } = pendingSession;
                     const res = await fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/changeActiveEntity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ glpiUrl, sessionToken, entities_id: selectedEntityId })
                     });
                     if (!res.ok) throw new Error("Falha ao mudar entidade");

                     // Update active entity in session data locally
                     pendingSession.fullSessionData.glpiactive_entity = selectedEntityId;
                     onLogin(pendingSession);
                } catch (e) {
                    setError(e.message);
                    setLoading(false);
                }
            };

            if (showEntitySelect) {
                return (
                    <div className="flex-1 flex flex-col justify-center p-6 max-w-md mx-auto w-full">
                        <div className="text-center mb-6">
                             <h1 className="text-xl font-bold text-slate-800">Selecione o Perfil</h1>
                             <p className="text-slate-500">Qual entidade voc√™ deseja acessar?</p>
                        </div>
                        <div className="space-y-3 max-h-[50vh] overflow-y-auto mb-6">
                            {entities.map(ent => (
                                <button key={ent.id} onClick={() => setSelectedEntityId(ent.id)}
                                    className={`w-full text-left p-4 border rounded-xl transition-all font-medium ${selectedEntityId === ent.id ? 'bg-blue-100 border-blue-500 text-blue-800 ring-2 ring-blue-200' : 'bg-white border-slate-200 text-slate-700 hover:bg-slate-50'}`}>
                                    {ent.name}
                                </button>
                            ))}
                        </div>

                        {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium text-center mb-4">{error}</div>}

                        <button onClick={confirmEntitySelection} disabled={loading || !selectedEntityId}
                            className="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 touch-btn flex items-center justify-center transition-all disabled:opacity-50 disabled:shadow-none">
                            {loading ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : "ENTRAR"}
                        </button>
                    </div>
                );
            }

            return (
                <div className="flex-1 flex flex-col justify-center p-6 max-w-md mx-auto w-full">
                    <div className="text-center mb-10">
                         <img src="assets/logo.png" alt="Logo" className="h-16 mx-auto mb-4 object-contain" />
                         <h1 className="text-2xl font-bold text-slate-800">Acesso T√©cnico</h1>
                         <p className="text-slate-500">Field Service</p>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Usu√°rio</label>
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    {User && <User className="h-5 w-5 text-slate-400" />}
                                </div>
                                <input type="text" value={username} onChange={e => setUsername(e.target.value)}
                                    className="pl-10 w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
                                    placeholder="Seu usu√°rio de rede" autoCapitalize="none" autoComplete="username" inputMode="text" required />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Senha</label>
                             <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    {Lock && <Lock className="h-5 w-5 text-slate-400" />}
                                </div>
                                <input type={showPassword ? "text" : "password"} value={password} onChange={e => setPassword(e.target.value)}
                                    className="pl-10 pr-12 w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
                                    placeholder="Sua senha" autoComplete="current-password" required />
                                <button type="button" onClick={() => setShowPassword(!showPassword)}
                                    className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-600 focus:outline-none">
                                    {showPassword ? (EyeOff && <EyeOff className="h-5 w-5"/>) : (Eye && <Eye className="h-5 w-5"/>)}
                                </button>
                            </div>
                        </div>

                        <div className="flex items-center">
                            <input id="remember-me" type="checkbox" checked={rememberMe} onChange={e => setRememberMe(e.target.checked)}
                                className="h-5 w-5 text-blue-600 rounded border-slate-300 focus:ring-blue-500" />
                            <label htmlFor="remember-me" className="ml-2 block text-sm text-slate-700 font-medium">Lembrar meu usu√°rio</label>
                        </div>

                        {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium text-center">{error}</div>}

                        <button type="submit" disabled={loading}
                            className="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 touch-btn flex items-center justify-center transition-all disabled:opacity-70">
                            {loading ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <span className="flex items-center gap-2 text-lg">ENTRAR {LogIn && <LogIn className="w-5 h-5" />}</span>}
                        </button>
                    </form>
                </div>
            );
        }

        // --- 3. TICKET DETAIL & RESPONSE ---
        function TicketDetail({ session, ticketId, onBack }) {
            const { sessionToken, glpiUrl } = session;
            const [ticket, setTicket] = useState(null);
            const [loading, setLoading] = useState(true);
            const [responseContent, setResponseContent] = useState('');
            const [evidence, setEvidence] = useState(null); // File object
            const [responseType, setResponseType] = useState('comment'); // 'comment' | 'solution'

            // Technical Data
            // Initialized as strings to detect "empty" vs "0"
            const [techData, setTechData] = useState({
                ponto: '',
                alcas: '',
                esticador: '',
                conector: '',
                metragemInicial: '',
                metragemFinal: '',
                drop: '',
                extras: ''
            });
            const [showHelp, setShowHelp] = useState(false);

            const metragemGasta = useMemo(() => {
                // Handle commas for Brazilian locale inputs
                const clean = (val) => String(val).replace(',', '.');
                const i = parseFloat(clean(techData.metragemInicial));
                const f = parseFloat(clean(techData.metragemFinal));
                if (isNaN(i) || isNaN(f)) return 0;
                // Use absolute difference as spools may count up or down
                return Math.abs(f - i).toFixed(2);
            }, [techData.metragemInicial, techData.metragemFinal]);

            // Stock Logic
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [stockItems, setStockItems] = useState([]);
            const [availableStock, setAvailableStock] = useState([]);
            const [selectedStockId, setSelectedStockId] = useState('');
            const [customItemName, setCustomItemName] = useState('');
            const [stockQty, setStockQty] = useState(1);
            const [isSubmitting, setIsSubmitting] = useState(false);

            // Fetch Detail
            useEffect(() => {
                const load = async () => {
                    try {
                        const res = await fetch(`https://portal-tecnoit-glpi.onrender.com/api/proxy/getTicketDetails/${ticketId}`, {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ glpiUrl, sessionToken })
                        });
                        if(res.ok) setTicket(await res.json());
                    } catch(e) { console.error(e); } finally { setLoading(false); }
                };
                load();

                // Fetch Stock
                fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/getConsumables', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ glpiUrl, sessionToken })
                })
                .then(r => {
                    if (!r.ok) throw new Error("Erro ao buscar insumos");
                    return r.json();
                })
                .then(data => {
                    if (Array.isArray(data)) setAvailableStock(data);
                    else console.error("Invalid stock data", data);
                })
                .catch(console.error);

            }, [ticketId]);

            // Handlers
            const handleAddStock = () => {
                 if (!selectedStockId || stockQty <= 0) return;
                 let itemName = '', itemId = selectedStockId;
                 if (selectedStockId === 'other') {
                     if (!customItemName.trim()) return alert("Digite o nome.");
                     itemName = customItemName; itemId = 'custom-' + Date.now();
                 } else {
                     const item = availableStock.find(s => String(s.id) === String(selectedStockId));
                     if (!item) return; itemName = item.name;
                 }
                 setStockItems(prev => [...prev, { id: itemId, name: itemName, qty: stockQty }]);
                 setSelectedStockId(''); setCustomItemName(''); setStockQty(1); setIsModalOpen(false);
            };

            const handleSubmit = async () => {
                if(!responseContent) return alert("Digite a descri√ß√£o da a√ß√£o realizada.");

                const isSolving = responseType === 'solution';

                // Validation for Solution
                if (isSolving) {
                    const requiredFields = [
                        { k: 'ponto', label: 'Ponto' },
                        { k: 'drop', label: 'Drop' },
                        { k: 'alcas', label: 'Al√ßas' },
                        { k: 'esticador', label: 'Esticador' },
                        { k: 'conector', label: 'Conector' },
                        { k: 'metragemInicial', label: 'Metragem Inicial' },
                        { k: 'metragemFinal', label: 'Metragem Final' }
                    ];

                    for (let f of requiredFields) {
                        if (techData[f.k] === '' || techData[f.k] === null || techData[f.k] === undefined) {
                            return alert(`O campo '${f.label}' √© obrigat√≥rio (use "0" se necess√°rio).`);
                        }
                    }

                    if (!evidence) return alert("√â obrigat√≥rio anexar uma evid√™ncia (foto).");
                }

                setIsSubmitting(true);
                try {
                    let finalContent = "";

                    if (isSolving) {
                        // Format Technical Data as HTML Table
                        finalContent += `
                            <div style="margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background-color: #f9f9f9;">
                                <h3 style="margin-top:0; color: #333;">üìã Dados T√©cnicos</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <tr><td style="padding: 4px; font-weight:bold;">Ponto:</td><td>${techData.ponto}</td></tr>
                                    <tr><td style="padding: 4px; font-weight:bold;">Drop:</td><td>${techData.drop}</td></tr>
                                    <tr><td style="padding: 4px; font-weight:bold;">Al√ßas:</td><td>${techData.alcas}</td></tr>
                                    <tr><td style="padding: 4px; font-weight:bold;">Esticador:</td><td>${techData.esticador}</td></tr>
                                    <tr><td style="padding: 4px; font-weight:bold;">Conector:</td><td>${techData.conector}</td></tr>
                                    <tr><td style="padding: 4px; font-weight:bold;">Metragem Inicial:</td><td>${techData.metragemInicial}m</td></tr>
                                    <tr><td style="padding: 4px; font-weight:bold;">Metragem Final:</td><td>${techData.metragemFinal}m</td></tr>
                                    <tr style="background-color: #eef;"><td style="padding: 4px; font-weight:bold;">Metragem Gasta:</td><td><b>${metragemGasta}m</b></td></tr>
                                    ${techData.extras ? `<tr><td style="padding: 4px; font-weight:bold;">Extras:</td><td>${techData.extras}</td></tr>` : ''}
                                </table>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>A√ß√£o Realizada:</strong><br/>
                                ${responseContent.replace(/\n/g, '<br>')}
                            </div>
                        `;
                    } else {
                        finalContent = responseContent.replace(/\n/g, '<br>');
                    }

                    // Upload Evidence if exists
                    // Note: In a real app we upload first, then link.
                    // For this prototype, we'll assume the proxy handles upload if we passed it, but our current proxy 'respondTicket' doesn't handle multipart.
                    // We must upload separately if evidence exists.
                    if (evidence) {
                        const formData = new FormData();
                        formData.append('file', evidence);
                        formData.append('glpiUrl', glpiUrl);
                        formData.append('sessionToken', sessionToken);

                        const uploadRes = await fetch(`https://portal-tecnoit-glpi.onrender.com/api/proxy/uploadDocument/${ticketId}`, {
                             method: 'POST',
                             body: formData
                        });

                        if (uploadRes.ok) {
                             finalContent += `<br><i>[Evid√™ncia anexada: ${evidence.name}]</i>`;
                        } else {
                            throw new Error("Falha ao enviar evid√™ncia.");
                        }
                    }

                    const payload = {
                        glpiUrl, sessionToken, ticketId,
                        content: finalContent,
                        status: isSolving ? 5 : 2, // 5=Solved, 2=Processing
                        stockItems,
                        entities_id: ticket.entities_id
                    };

                    const res = await fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/respondTicket', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    if (!res.ok || (data.errors && data.errors.length > 0)) {
                        let msg = data.message || "Erro ao responder.";
                        if (data.errors) msg += "\n" + data.errors.join("\n");
                        throw new Error(msg);
                    }

                    alert(isSolving ? "Chamado solucionado!" : "Resposta enviada!");
                    onBack();
                } catch(e) { alert("Erro: " + e.message); } finally { setIsSubmitting(false); }
            };

            if(loading) return <LoadingScreen message="Carregando chamado..." />;
            if(!ticket) return <div className="p-4">Erro ao carregar. <button onClick={onBack}>Voltar</button></div>;

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    {/* Header */}
                    <div className="bg-white p-4 shadow-sm flex items-center justify-between z-20">
                         <div className="flex items-center gap-4">
                             <button onClick={onBack} className="p-2 -ml-2 text-slate-500 rounded-full"><ChevronDown className="w-6 h-6 rotate-90" /></button>
                             <div>
                                 <h2 className="text-lg font-bold text-slate-800 leading-tight">Chamado #{ticket.id}</h2>
                                 <p className="text-xs text-slate-500">{ticket.name}</p>
                             </div>
                         </div>
                         <button onClick={() => setShowHelp(true)} className="p-2 text-blue-600 bg-blue-50 rounded-full font-bold w-10 h-10 flex items-center justify-center">?</button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {/* Info Card */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                             <div className="flex justify-between mb-2">
                                <span className="text-xs font-bold px-2 py-1 bg-blue-100 text-blue-700 rounded-md">Status: {ticket.status}</span>
                                <span className="text-xs text-slate-400">{ticket.date}</span>
                             </div>
                             <div className="text-sm text-slate-600" dangerouslySetInnerHTML={{__html: ticket.content}} />
                        </div>

                        {/* Response Type Toggle */}
                        <div className="flex p-1 bg-slate-200 rounded-lg">
                            <button onClick={() => setResponseType('comment')}
                                className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${responseType === 'comment' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500'}`}>
                                Coment√°rio
                            </button>
                            <button onClick={() => setResponseType('solution')}
                                className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${responseType === 'solution' ? 'bg-green-600 text-white shadow-sm' : 'text-slate-500'}`}>
                                Solucionar
                            </button>
                        </div>

                        {/* Response Form */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 space-y-4">

                            {/* Technical Fields (Only for Solution) */}
                            {responseType === 'solution' && (
                                <div className="space-y-3 p-3 bg-slate-50 rounded-lg border border-slate-200 animate-fade-in">
                                    <h4 className="font-bold text-slate-700 text-sm">Dados T√©cnicos <span className="text-red-500">* Obrigat√≥rios</span></h4>

                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500">Ponto <span className="text-red-500">*</span></label>
                                            <input type="text" value={techData.ponto} onChange={e => setTechData({...techData, ponto: e.target.value})} className="w-full p-2 border rounded-lg bg-white" placeholder="Nome/ID" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500">Drop <span className="text-red-500">*</span></label>
                                            <input type="text" value={techData.drop} onChange={e => setTechData({...techData, drop: e.target.value})} className="w-full p-2 border rounded-lg bg-white" placeholder="Tipo/Metros" />
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-3 gap-2">
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500">Al√ßas <span className="text-red-500">*</span></label>
                                            <input type="number" min="0" value={techData.alcas} onChange={e => setTechData({...techData, alcas: e.target.value})} className="w-full p-2 border rounded-lg bg-white" placeholder="Qtd" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500">Esticador <span className="text-red-500">*</span></label>
                                            <input type="number" min="0" value={techData.esticador} onChange={e => setTechData({...techData, esticador: e.target.value})} className="w-full p-2 border rounded-lg bg-white" placeholder="Qtd" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500">Conector <span className="text-red-500">*</span></label>
                                            <input type="number" min="0" value={techData.conector} onChange={e => setTechData({...techData, conector: e.target.value})} className="w-full p-2 border rounded-lg bg-white" placeholder="Qtd" />
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500">Metr. Inicial <span className="text-red-500">*</span></label>
                                            <input type="number" min="0" value={techData.metragemInicial} onChange={e => setTechData({...techData, metragemInicial: e.target.value})} className="w-full p-2 border rounded-lg bg-white" placeholder="Metros" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500">Metr. Final <span className="text-red-500">*</span></label>
                                            <input type="number" min="0" value={techData.metragemFinal} onChange={e => setTechData({...techData, metragemFinal: e.target.value})} className="w-full p-2 border rounded-lg bg-white" placeholder="Metros" />
                                        </div>
                                    </div>

                                    <div className="p-2 bg-blue-50 text-blue-800 rounded text-center text-sm font-bold">
                                        Gasto: {metragemGasta}m
                                    </div>

                                    <div>
                                        <label className="text-xs font-semibold text-slate-500">Materiais Extras</label>
                                        <input type="text" value={techData.extras} onChange={e => setTechData({...techData, extras: e.target.value})} className="w-full p-2 border rounded-lg bg-white" placeholder="Ex: Fita isolante, Parafusos..." />
                                    </div>
                                </div>
                            )}

                            <div>
                                <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-2">
                                    <RefreshCw className="w-4 h-4"/> {responseType === 'solution' ? 'Descri√ß√£o da Solu√ß√£o / A√ß√£o Realizada' : 'Coment√°rio'}
                                </h3>
                                <textarea value={responseContent} onChange={e => setResponseContent(e.target.value)}
                                    className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 h-32 outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder={responseType === 'solution' ? "Descreva o que foi feito..." : "Escreva sua mensagem..."} />
                            </div>

                             {/* Evidence - Mandatory for Solution */}
                             <div>
                                 <label className={`block text-sm font-semibold mb-1 ${responseType === 'solution' && !evidence ? 'text-red-600' : 'text-slate-700'}`}>
                                     {responseType === 'solution' ? 'Evid√™ncia (Obrigat√≥rio) *' : 'Evid√™ncia (Opcional)'}
                                 </label>
                                 <input type="file" onChange={e => setEvidence(e.target.files[0])}
                                    className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                             </div>
                        </div>

                        {/* Stock (Consumables) */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 space-y-3">
                             <div className="flex justify-between items-center">
                                 <h3 className="font-bold text-slate-700 flex items-center gap-2"><Box className="w-4 h-4"/> Insumos do Sistema</h3>
                                 <button onClick={() => setIsModalOpen(true)} className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">+ Add</button>
                             </div>
                             {stockItems.length === 0 && <p className="text-xs text-slate-400">Nenhum insumo selecionado.</p>}
                             {stockItems.map((item, i) => (
                                 <div key={i} className="flex justify-between text-sm p-2 bg-slate-50 rounded border border-slate-100">
                                     <span>{item.qty}x {item.name}</span>
                                     <span className="text-red-500" onClick={() => setStockItems(p => p.filter((_, idx) => idx !== i))}>X</span>
                                 </div>
                             ))}
                        </div>
                    </div>

                    {/* Footer Actions */}
                    <div className="bg-white p-4 border-t border-slate-200 shadow-lg z-20">
                        <button onClick={handleSubmit} disabled={isSubmitting}
                            className={`w-full font-bold py-4 rounded-xl shadow-lg transition-all ${
                                responseType === 'solution'
                                ? 'bg-green-600 hover:bg-green-700 text-white shadow-green-200'
                                : 'bg-slate-700 hover:bg-slate-800 text-white shadow-slate-300'
                            }`}>
                            {isSubmitting ? 'Enviando...' : (responseType === 'solution' ? 'FINALIZAR CHAMADO' : 'ENVIAR RESPOSTA')}
                        </button>
                    </div>

                    {/* Help/Onboarding Modal */}
                    {showHelp && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative">
                                <button onClick={() => setShowHelp(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><XCircle className="w-6 h-6"/></button>

                                <h3 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <span className="bg-blue-100 text-blue-600 p-2 rounded-lg"><RefreshCw className="w-5 h-5"/></span>
                                    Como Responder?
                                </h3>

                                <div className="space-y-4">
                                    <div className="p-3 bg-slate-50 rounded-xl border border-slate-100">
                                        <h4 className="font-bold text-slate-700 mb-1">üìù Coment√°rio</h4>
                                        <p className="text-sm text-slate-500 leading-relaxed">
                                            Use esta op√ß√£o para d√∫vidas, avisos ou intera√ß√µes parciais. O chamado <b>n√£o ser√° encerrado</b> e continuar√° pendente.
                                        </p>
                                    </div>

                                    <div className="p-3 bg-green-50 rounded-xl border border-green-100">
                                        <h4 className="font-bold text-green-800 mb-1">‚úÖ Solucionar</h4>
                                        <p className="text-sm text-green-700 leading-relaxed">
                                            Use para <b>finalizar</b> o servi√ßo. √â obrigat√≥rio preencher todos os dados t√©cnicos (Ponto, Drop, Metragens...) e anexar a foto da evid√™ncia.
                                        </p>
                                        <p className="text-xs text-green-600 mt-2 font-bold">
                                            * Se usou 0 materiais, preencha com "0".
                                        </p>
                                    </div>
                                </div>

                                <button onClick={() => setShowHelp(false)} className="w-full mt-6 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-200">
                                    Entendi
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Stock Modal (Simplified) */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 space-y-4">
                                <h3>Adicionar Insumo</h3>
                                <select value={selectedStockId} onChange={e => setSelectedStockId(e.target.value)} className="w-full p-3 border rounded-xl">
                                    <option value="">Selecione...</option>
                                    {availableStock.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                    <option value="other">Outro...</option>
                                </select>
                                {selectedStockId === 'other' && <input value={customItemName} onChange={e => setCustomItemName(e.target.value)} placeholder="Nome" className="w-full p-3 border rounded-xl" />}
                                <input type="number" value={stockQty} onChange={e => setStockQty(e.target.value)} className="w-full p-3 border rounded-xl" />
                                <div className="flex gap-2">
                                    <button onClick={() => setIsModalOpen(false)} className="flex-1 p-3 bg-slate-100 rounded-xl">Cancelar</button>
                                    <button onClick={handleAddStock} className="flex-1 p-3 bg-blue-600 text-white rounded-xl">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 2. DASHBOARD (Ticket List) ---
        function Dashboard({ session, onNavigate, onLogout }) {
            const { sessionToken, fullSessionData, glpiUrl } = session;
            const userName = fullSessionData?.glpifirstname || 'T√©cnico';
            const userId = fullSessionData?.glpiID ? parseInt(fullSessionData.glpiID) : 0;

            const [tickets, setTickets] = useState([]);
            const [filter, setFilter] = useState('new'); // new, pending, solved, me
            const [loading, setLoading] = useState(true);
            const [range, setRange] = useState(50);
            const [showSearch, setShowSearch] = useState(false);
            const [searchText, setSearchText] = useState('');

            // Fetch Tickets
            useEffect(() => {
                const load = async () => {
                    setLoading(true);
                    try {
                        const res = await fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/getTickets', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ glpiUrl, sessionToken, range: `0-${range-1}` })
                        });
                        const data = await res.json();
                        setTickets(data.tickets || []);
                    } catch(e) { console.error(e); } finally { setLoading(false); }
                };
                load();
            }, [glpiUrl, sessionToken, range]);

            // Simple Filter Logic (Client-side for prototype)
            // GLPI Status: 1=New, 2=Assign, 3=Plan, 4=Wait, 5=Solved, 6=Closed
            const filteredTickets = tickets.filter(t => {
                const s = t.status;
                const matchesSearch = searchText ? (
                    (t.name && t.name.toLowerCase().includes(searchText.toLowerCase())) ||
                    (String(t.id).includes(searchText))
                ) : true;

                if (!matchesSearch) return false;

                if(filter === 'me') {
                     // Check if I am the assigned technician (users_id_assign) or recipient
                     // Note: GLPI response for users_id_assign can be int or array in some versions/contexts?
                     // Assuming simple view returns basic fields. get_my_tickets usually filters by actor.
                     // We check both for robustness.
                     return (t.users_id_assign === userId || t.users_id_recipient === userId);
                }
                if(filter === 'new') return (s === 1 || s === 2 || s === 3); // Em atendimento
                if(filter === 'pending') return s === 4; // Pendente
                if(filter === 'solved') return (s === 5 || s === 6); // Solucionado
                return true;
            });

            return (
                <div className="flex-1 flex flex-col h-full bg-slate-50">
                    <header className="bg-white p-4 shadow-sm z-10 flex justify-between items-center sticky top-0">
                        {showSearch ? (
                            <div className="flex-1 flex items-center gap-2 animate-fade-in">
                                <div className="relative flex-1">
                                    <input autoFocus type="text" value={searchText} onChange={e => setSearchText(e.target.value)}
                                        className="w-full pl-3 pr-8 py-2 bg-slate-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Buscar ID ou T√≠tulo..." />
                                    {searchText && <button onClick={() => setSearchText('')} className="absolute right-2 top-2 text-slate-400"><X className="w-4 h-4"/></button>}
                                </div>
                                <button onClick={() => { setShowSearch(false); setSearchText(''); }} className="text-slate-500 font-medium text-sm">Cancelar</button>
                            </div>
                        ) : (
                            <>
                                <div className="flex items-center gap-3">
                                     <div className="w-9 h-9 bg-blue-100 rounded-full flex items-center justify-center text-blue-700 font-bold border-2 border-white shadow-sm">{userName.charAt(0)}</div>
                                     <div className="flex flex-col">
                                         <span className="font-bold text-slate-800 text-sm leading-tight">{userName}</span>
                                         <span className="text-[10px] text-slate-500 font-medium tracking-wide">FIELD SERVICE</span>
                                     </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button onClick={() => setShowSearch(true)} className="p-2 text-slate-600 bg-slate-50 rounded-full hover:bg-slate-100"><Search className="w-5 h-5"/></button>
                                    <button onClick={onLogout} className="text-xs bg-red-50 text-red-600 px-3 py-1.5 rounded-lg font-bold">Sair</button>
                                </div>
                            </>
                        )}
                    </header>

                    {/* Filter Tabs */}
                    <div className="flex px-4 py-3 gap-3 overflow-x-auto bg-white border-b border-slate-100 no-scrollbar">
                        {[
                            {id: 'me', label: 'Para Mim'},
                            {id: 'new', label: 'Em Andamento'},
                            {id: 'pending', label: 'Pendentes'},
                            {id: 'solved', label: 'Finalizados'}
                        ].map(tab => (
                            <button key={tab.id} onClick={() => setFilter(tab.id)}
                                className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${filter === tab.id ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-500'}`}>
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {/* List */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {loading ? <p className="text-center text-slate-400 mt-10">Carregando chamados...</p> : (
                            filteredTickets.length === 0 ? (
                                <div className="flex flex-col items-center justify-center mt-10 text-slate-400 gap-2">
                                    <div className="bg-slate-100 p-4 rounded-full"><Box className="w-8 h-8 opacity-50"/></div>
                                    <p>Nenhum chamado encontrado.</p>
                                </div>
                            ) :
                            filteredTickets.map(t => (
                                <div key={t.id} onClick={() => onNavigate('ticketDetail', t.id)}
                                    className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 active:scale-98 transition-transform cursor-pointer hover:shadow-md">
                                    <div className="flex justify-between items-start mb-1 gap-2">
                                        <h4 className="font-bold text-slate-800 text-sm line-clamp-2 leading-snug flex-1">{t.name}</h4>
                                        <span className="text-xs font-mono font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded">#{t.id}</span>
                                    </div>
                                    <div className="text-xs text-slate-500 mb-3 line-clamp-2 h-8" dangerouslySetInnerHTML={{__html: t.content}}></div>
                                    <div className="flex items-center justify-between text-xs pt-2 border-t border-slate-50">
                                        <div className="flex items-center gap-1 text-slate-400">
                                            <span>üìÖ {t.date_mod || t.date}</span>
                                        </div>
                                        <span className={`px-2 py-0.5 rounded font-bold ${t.status === 5 || t.status === 6 ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>
                                            {t.status === 5 || t.status === 6 ? 'Finalizado' : 'Aberto'}
                                        </span>
                                    </div>
                                </div>
                            ))
                        )}

                        {/* Pagination Control */}
                        {!loading && tickets.length > 0 && (
                            <div className="py-4 flex justify-center items-center gap-2 text-sm text-slate-500">
                                <span>Exibir:</span>
                                <select value={range} onChange={e => setRange(Number(e.target.value))} className="bg-white border border-slate-200 rounded p-1 font-bold">
                                    <option value={10}>10</option>
                                    <option value={25}>25</option>
                                    <option value={50}>50</option>
                                    <option value={100}>100</option>
                                </select>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppWrapper />);
    </script>
</body>
</html>
