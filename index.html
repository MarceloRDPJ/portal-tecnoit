<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TecnoiT - Field Closing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="assets/logo.png">
    <style>
        body { font-family: 'Roboto', sans-serif; -webkit-font-smoothing: antialiased; background-color: #f8fafc; }
        .touch-btn:active { transform: scale(0.98); }
        input, textarea, select { font-size: 16px !important; } /* Prevent iOS zoom */
        .modal-overlay { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">
    <!-- Use 100dvh for better mobile support -->
    <div id="root" class="h-[100dvh] flex flex-col max-w-2xl mx-auto shadow-2xl bg-white"></div>

    <script>
       const firebaseConfig = {
            apiKey: "AIzaSyCh47eM6oXz-vN-2iAZXbDtTIi0CvFe_wY",
            authDomain: "app-tecnoit.firebaseapp.com",
            projectId: "app-tecnoit",
            storageBucket: "app-tecnoit.firebasestorage.app",
            messagingSenderId: "675993906644",
            appId: "1:675993906644:web:90f5fdbbb852a5caa43a41",
            measurementId: "G-MLEH036DLK"
        };
    </script>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        const lucideReactUrl = "https://cdn.skypack.dev/lucide-react";
        let User, Lock, LogIn, PlusCircle, Camera, Mic, Box, Trash2, CheckCircle, XCircle, ChevronDown, Wifi, WifiOff, RefreshCw, Eye, EyeOff;

        // Firebase is kept for potential future use or auth if needed, but the main logic is now Proxy-based
        const firebaseAppUrl = "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        const firebaseAuthUrl = "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        const firestoreUrl = "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        function AppWrapper() {
            const [libsLoaded, setLibsLoaded] = useState(false);
            useEffect(() => {
                Promise.all([import(lucideReactUrl), import(firebaseAppUrl), import(firebaseAuthUrl), import(firestoreUrl)])
                    .then(([lucide, app, auth, firestore]) => {
                        ({ User, Lock, LogIn, PlusCircle, Camera, Mic, Box, Trash2, CheckCircle, XCircle, ChevronDown, Wifi, WifiOff, RefreshCw, Eye, EyeOff } = lucide);
                        window.firebase = { app, auth, firestore };
                        setLibsLoaded(true);
                    }).catch(error => console.error("Falha ao carregar as bibliotecas:", error));
            }, []);

            if (!libsLoaded) return <LoadingScreen message="Iniciando sistema..." />;
            return <App />;
        }

        const APP_VERSION = '1.1.0';

        function App() {
            const { initializeApp } = window.firebase.app;
            const { getAuth, onAuthStateChanged, signInAnonymously } = window.firebase.auth;
            const app = useMemo(() => initializeApp(firebaseConfig), []);
            const auth = useMemo(() => getAuth(app), [app]);

            // App State
            const [view, setView] = useState('login'); // login, dashboard, newTicket, success
            const [user, setUser] = useState(null); // Firebase User
            const [glpiSession, setGlpiSession] = useState(null); // { sessionToken, fullSessionData, glpiUrl }
            const [isLoading, setIsLoading] = useState(true);

            // Init Firebase Auth (Anonymous for simplicity as we use GLPI Auth)
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
                return () => unsubscribe();
            }, [auth]);

            // Check for saved GLPI Session on startup & Cache Busting
            useEffect(() => {
                const checkSession = async () => {
                   // Check Version to force refresh if needed
                   const savedVersion = localStorage.getItem('appVersion');
                   if (savedVersion !== APP_VERSION) {
                       console.log("New version detected. Clearing old session.");
                       localStorage.removeItem('glpiSessionData');
                       localStorage.setItem('appVersion', APP_VERSION);
                   }

                   const savedCreds = localStorage.getItem('glpiSessionData');
                   if (savedCreds) {
                       try {
                           const parsed = JSON.parse(savedCreds);
                           setGlpiSession(parsed);
                           setView('dashboard');
                       } catch (e) {
                           localStorage.removeItem('glpiSessionData');
                       }
                   }
                   setIsLoading(false);
                };
                if (user) checkSession();
            }, [user]);

            const handleLoginSuccess = (sessionData) => {
                setGlpiSession(sessionData);
                localStorage.setItem('glpiSessionData', JSON.stringify(sessionData));
                setView('dashboard');
            };

            const handleLogout = () => {
                setGlpiSession(null);
                localStorage.removeItem('glpiSessionData');
                setView('login');
            };

            if (isLoading) return <LoadingScreen message="Verificando sessão..." />;

            return (
                <div className="flex flex-col h-full bg-slate-50">
                     {view === 'login' && <LoginScreen onLogin={handleLoginSuccess} />}
                     {view === 'dashboard' && <Dashboard session={glpiSession} onNavigate={setView} onLogout={handleLogout} />}
                     {view === 'newTicket' && <NewTicketForm session={glpiSession} onBack={() => setView('dashboard')} />}
                </div>
            );
        }

        const LoadingScreen = ({ message }) => (
             <div className="flex flex-col items-center justify-center h-full bg-slate-50">
                <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p className="text-lg font-medium text-slate-600 animate-pulse">{message}</p>
            </div>
        );

        // --- 1. LOGIN SIMPLIFICADO ---
        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(true);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                const savedUser = localStorage.getItem('glpiUsername');
                if (savedUser) setUsername(savedUser);
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');

                try {
                    const glpiUrl = 'https://suporte.tecnoit.com.br';

                    const res = await fetch('https://tecnoit-glpi-proxy.onrender.com/api/proxy/initSession', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ glpiUrl, username, password, get_full_session: true })
                    });

                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'Falha na autenticação');

                    if (rememberMe) localStorage.setItem('glpiUsername', username);
                    else localStorage.removeItem('glpiUsername');

                    let fullSession = null;

                    // STRICT CHECK: Ensure glpimy_entities is present.
                    // If the "Fast Login" returns session but NO entities, we MUST fetch full session.
                    if (data.session && data.session.glpimy_entities) {
                        fullSession = data.session;
                    } else {
                        // Fallback to Full Fetch if entities are missing
                        const sessionRes = await fetch('https://tecnoit-glpi-proxy.onrender.com/api/proxy/getFullSession', {
                            method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ glpiUrl, sessionToken: data.session_token })
                        });

                        if(!sessionRes.ok) throw new Error('Erro ao carregar perfil do usuário');
                        fullSession = (await sessionRes.json()).session;
                    }

                    onLogin({
                        sessionToken: data.session_token,
                        fullSessionData: fullSession,
                        glpiUrl
                    });

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex-1 flex flex-col justify-center p-6 max-w-md mx-auto w-full">
                    <div className="text-center mb-10">
                         <img src="assets/logo.png" alt="Logo" className="h-16 mx-auto mb-4 object-contain" />
                         <h1 className="text-2xl font-bold text-slate-800">Acesso Técnico</h1>
                         <p className="text-slate-500">Field Service</p>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Usuário</label>
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    {User && <User className="h-5 w-5 text-slate-400" />}
                                </div>
                                <input type="text" value={username} onChange={e => setUsername(e.target.value)}
                                    className="pl-10 w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
                                    placeholder="Seu usuário de rede" autoCapitalize="none" autoComplete="username" inputMode="text" required />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Senha</label>
                             <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    {Lock && <Lock className="h-5 w-5 text-slate-400" />}
                                </div>
                                <input type={showPassword ? "text" : "password"} value={password} onChange={e => setPassword(e.target.value)}
                                    className="pl-10 pr-12 w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
                                    placeholder="Sua senha" autoComplete="current-password" required />
                                <button type="button" onClick={() => setShowPassword(!showPassword)}
                                    className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-600 focus:outline-none">
                                    {showPassword ? (EyeOff && <EyeOff className="h-5 w-5"/>) : (Eye && <Eye className="h-5 w-5"/>)}
                                </button>
                            </div>
                        </div>

                        <div className="flex items-center">
                            <input id="remember-me" type="checkbox" checked={rememberMe} onChange={e => setRememberMe(e.target.checked)}
                                className="h-5 w-5 text-blue-600 rounded border-slate-300 focus:ring-blue-500" />
                            <label htmlFor="remember-me" className="ml-2 block text-sm text-slate-700 font-medium">Lembrar meu usuário</label>
                        </div>

                        {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium text-center">{error}</div>}

                        <button type="submit" disabled={loading}
                            className="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 touch-btn flex items-center justify-center transition-all disabled:opacity-70">
                            {loading ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <span className="flex items-center gap-2 text-lg">ENTRAR {LogIn && <LogIn className="w-5 h-5" />}</span>}
                        </button>
                    </form>
                </div>
            );
        }

        // --- 3. NEW TICKET FORM ---
        function NewTicketForm({ session, onBack }) {
            const { sessionToken, fullSessionData, glpiUrl } = session;

            // State
            const [entityId, setEntityId] = useState('');
            const [entityName, setEntityName] = useState('');
            const [availableEntities, setAvailableEntities] = useState([]);

            const [activityType, setActivityType] = useState('Manutenção Padrão');
            const [fiberStart, setFiberStart] = useState('');
            const [fiberEnd, setFiberEnd] = useState('');

            const [problemDescription, setProblemDescription] = useState('');
            const [solutionDescription, setSolutionDescription] = useState('');
            const [evidence, setEvidence] = useState(null);

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [stockItems, setStockItems] = useState([]); // Array of { id, name, qty }
            const [availableStock, setAvailableStock] = useState([]); // From API

            // Modal Inputs
            const [selectedStockId, setSelectedStockId] = useState('');
            const [customItemName, setCustomItemName] = useState('');
            const [stockQty, setStockQty] = useState(1);

            const [isSubmitting, setIsSubmitting] = useState(false);
            const [activeDictationField, setActiveDictationField] = useState(null); // 'problem' or 'solution'

            // --- A. Entity Logic ---
            useEffect(() => {
                if (fullSessionData) {
                    const activeId = fullSessionData.glpiactive_entity || '';
                    const activeName = fullSessionData.glpiactive_entity_name || 'Entidade Padrão';

                    setEntityId(activeId);
                    setEntityName(activeName);

                    // Robust Entity Parsing
                    // GLPI can return glpimy_entities as:
                    // 1. Array of Objects: [{id: 1, name: "A"}, ...]
                    // 2. Object of Objects: { "1": {id: 1, name: "A"}, ... } (Self-Tree)
                    // 3. Object of Strings: { "1": "Name A", "2": "Name B" } (Simple Map)
                    let parsedEntities = [];
                    const rawEntities = fullSessionData.glpimy_entities;

                    if (Array.isArray(rawEntities)) {
                        parsedEntities = rawEntities;
                    } else if (typeof rawEntities === 'object' && rawEntities !== null) {
                        // Handle Object formats
                        parsedEntities = Object.entries(rawEntities).map(([key, value]) => {
                            if (typeof value === 'object' && value !== null) {
                                // Case 2: { "1": {id: 1, name: "A"} }
                                return { id: value.id || key, name: value.name || value.completename || 'Entidade ' + key };
                            } else {
                                // Case 3: { "1": "Name A" }
                                return { id: key, name: value };
                            }
                        });
                    }

                    // Fallback
                    if (parsedEntities.length === 0) {
                        parsedEntities = [{ id: activeId, name: activeName }];
                    }

                    setAvailableEntities(parsedEntities);
                }
            }, [fullSessionData]);

            const handleEntityChange = (e) => {
                const newId = e.target.value;
                setEntityId(newId);
                const ent = availableEntities.find(en => String(en.id) === String(newId));
                if (ent) setEntityName(ent.name);
            };

            // --- B. Stock Fetch Logic ---
            useEffect(() => {
                const fetchStock = async () => {
                    try {
                        const res = await fetch('https://tecnoit-glpi-proxy.onrender.com/api/proxy/getConsumables', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ glpiUrl, sessionToken })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            setAvailableStock(data);
                        } else {
                            // Fallback for UI testing if API missing
                            console.warn("API de estoque não encontrada. Usando dados fictícios.");
                            setAvailableStock([
                                { id: 1, name: 'Cabo UTP (metros)' },
                                { id: 2, name: 'Conector RJ45' },
                                { id: 3, name: 'Fita Isolante' },
                                { id: 4, name: 'Roteador Wi-Fi' }
                            ]);
                        }
                    } catch (e) {
                        console.error("Erro ao buscar estoque", e);
                         setAvailableStock([
                                { id: 1, name: 'Cabo UTP (metros)' },
                                { id: 2, name: 'Conector RJ45' },
                                { id: 3, name: 'Fita Isolante' },
                                { id: 4, name: 'Roteador Wi-Fi' }
                        ]);
                    }
                };
                fetchStock();
            }, [glpiUrl, sessionToken]);

            // --- Dictation Logic ---
            const toggleDictation = (field) => {
                if (!('webkitSpeechRecognition' in window)) {
                    alert("Seu navegador não suporta ditado.");
                    return;
                }

                if (activeDictationField === field) {
                    setActiveDictationField(null); // Stop
                    return;
                }

                const recognition = new window.webkitSpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => setActiveDictationField(field);
                recognition.onend = () => setActiveDictationField(null);
                recognition.onerror = (event) => { console.error(event.error); setActiveDictationField(null); };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const setter = field === 'problem' ? setProblemDescription : setSolutionDescription;
                    setter(prev => (prev ? prev + ' ' + transcript : transcript));
                };

                recognition.start();
            };

            // --- Stock Helpers ---
            const handleAddStock = () => {
                if (!selectedStockId || stockQty <= 0) return;

                let itemName = '';
                let itemId = selectedStockId;

                if (selectedStockId === 'other') {
                    if (!customItemName.trim()) return alert("Digite o nome do material.");
                    itemName = customItemName;
                    itemId = 'custom-' + Date.now();
                } else {
                    const item = availableStock.find(s => String(s.id) === String(selectedStockId));
                    if (!item) return;
                    itemName = item.name;
                }

                setStockItems(prev => [...prev, { id: itemId, name: itemName, qty: stockQty }]);

                // Reset
                setSelectedStockId('');
                setCustomItemName('');
                setStockQty(1);
                setIsModalOpen(false);
            };

            const removeStockItem = (index) => {
                setStockItems(prev => prev.filter((_, i) => i !== index));
            };

            // --- Submission ---
            const handleSubmit = async () => {
                if (!problemDescription || !solutionDescription) return alert("Descreva o problema e a solução.");
                if (activityType === 'Troca de Fibra' && (!fiberStart || !fiberEnd)) return alert("Informe a metragem da fibra.");

                setIsSubmitting(true);
                try {
                    // Construct Rich Content
                    let finalContent = `
                        <h2>Relatório de Campo</h2>
                        <p><strong>Atividade:</strong> ${activityType}</p>
                        <p><strong>Problema Encontrado:</strong> ${problemDescription}</p>
                        <p><strong>Solução Realizada:</strong> ${solutionDescription}</p>
                    `;

                    if (activityType === 'Troca de Fibra') {
                        const used = parseFloat(fiberEnd) - parseFloat(fiberStart);
                        finalContent += `
                            <h3>Troca de Fibra</h3>
                            <ul>
                                <li>Metragem Inicial: ${fiberStart}</li>
                                <li>Metragem Final: ${fiberEnd}</li>
                                <li><strong>Total Utilizado: ${used.toFixed(2)} metros</strong></li>
                            </ul>
                        `;
                    }

                    if (stockItems.length > 0) {
                         finalContent += `<h3>Materiais Utilizados</h3><ul>`;
                         stockItems.forEach(item => {
                             finalContent += `<li>${item.qty}x ${item.name}</li>`;
                         });
                         finalContent += `</ul>`;
                    }

                    // Create Ticket Payload
                    const payload = {
                        glpiUrl,
                        sessionToken,
                        input: {
                            name: `${activityType} - ${entityName}`, // Auto-title
                            content: finalContent,
                            entities_id: entityId,
                            status: 2, // Em atendimento / Novo
                        },
                        stockItems
                    };

                    const res = await fetch('https://tecnoit-glpi-proxy.onrender.com/api/proxy/createTicket', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) throw new Error("Erro ao criar chamado.");

                    alert("Chamado finalizado com sucesso!");
                    onBack(); // Go back to dashboard
                } catch (e) {
                    alert("Erro ao finalizar: " + e.message);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleFileChange = (e) => {
                if (e.target.files[0]) setEvidence(e.target.files[0]);
            };

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    {/* Header */}
                    <div className="bg-white p-4 shadow-sm flex items-center gap-4 z-20 flex-shrink-0">
                         <button onClick={onBack} className="p-2 -ml-2 text-slate-500 hover:bg-slate-100 rounded-full">
                            <ChevronDown className="w-6 h-6 rotate-90" />
                         </button>
                         <h2 className="text-xl font-bold text-slate-800">Novo Atendimento</h2>
                    </div>

                    {/* Content - Flex Grow with Overflow */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-6">

                        {/* Bloco A: Identificação & Atividade */}
                        <section className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                            <div className="flex items-center gap-2 mb-2 border-b border-slate-100 pb-2">
                                <Box className="w-5 h-5 text-blue-600" />
                                <h3 className="font-bold text-slate-700">Dados do Atendimento</h3>
                            </div>

                            {/* Entity Selector */}
                            <div>
                                <label className="block text-sm font-semibold text-slate-500 mb-1">Cliente / Entidade</label>
                                {availableEntities.length > 1 ? (
                                    <select value={entityId} onChange={handleEntityChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-medium text-slate-800">
                                        {availableEntities.map(ent => (
                                            <option key={ent.id} value={ent.id}>{ent.name}</option>
                                        ))}
                                    </select>
                                ) : (
                                    <div className="p-3 bg-slate-100 rounded-xl text-slate-800 font-medium border border-slate-200">
                                        {entityName}
                                    </div>
                                )}
                            </div>

                            {/* Activity Type */}
                            <div>
                                <label className="block text-sm font-semibold text-slate-500 mb-1">Tipo de Atividade</label>
                                <select value={activityType} onChange={e => setActivityType(e.target.value)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                    <option value="Manutenção Padrão">Manutenção Padrão</option>
                                    <option value="Instalação">Instalação</option>
                                    <option value="Configuração">Configuração</option>
                                    <option value="Troca de Fibra">Troca de Fibra</option>
                                    <option value="Vistoria">Vistoria</option>
                                </select>
                            </div>

                            {/* Conditional Fiber Inputs */}
                            {activityType === 'Troca de Fibra' && (
                                <div className="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded-xl border border-blue-100 animate-fade-in">
                                    <div>
                                        <label className="block text-xs font-bold text-blue-700 mb-1">Metragem Inicial</label>
                                        <input type="number" value={fiberStart} onChange={e => setFiberStart(e.target.value)} placeholder="0.00" inputMode="decimal" className="w-full p-2 rounded-lg border border-blue-200 outline-none focus:border-blue-500" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-blue-700 mb-1">Metragem Final</label>
                                        <input type="number" value={fiberEnd} onChange={e => setFiberEnd(e.target.value)} placeholder="0.00" inputMode="decimal" className="w-full p-2 rounded-lg border border-blue-200 outline-none focus:border-blue-500" />
                                    </div>
                                    <div className="col-span-2 text-center text-sm font-bold text-blue-800">
                                        Total: {((parseFloat(fiberEnd)||0) - (parseFloat(fiberStart)||0)).toFixed(2)}m
                                    </div>
                                </div>
                            )}
                        </section>

                        {/* Bloco B: Relato Inteligente */}
                        <section className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                             <div className="flex items-center gap-2 mb-2 border-b border-slate-100 pb-2">
                                <RefreshCw className="w-5 h-5 text-blue-600" />
                                <h3 className="font-bold text-slate-700">Relato Técnico</h3>
                            </div>

                            {/* Problem */}
                            <div className="relative">
                                <label className="block text-sm font-semibold text-slate-500 mb-1">Problema Encontrado</label>
                                <div className="relative">
                                    <textarea value={problemDescription} onChange={e => setProblemDescription(e.target.value)}
                                        rows="3" placeholder="Ex: Fibra rompida na caixa de emenda..."
                                        className="w-full p-3 pr-12 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none appearance-none" />
                                    <button onClick={() => toggleDictation('problem')} type="button"
                                        className={`absolute right-2 bottom-2 p-2 rounded-lg transition-all active:scale-95 ${activeDictationField === 'problem' ? 'bg-red-500 text-white shadow-md animate-pulse' : 'bg-white text-slate-400 border border-slate-200 shadow-sm hover:text-blue-600'}`}>
                                        <Mic className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>

                            {/* Solution */}
                            <div className="relative">
                                <label className="block text-sm font-semibold text-slate-500 mb-1">Solução Realizada</label>
                                <div className="relative">
                                    <textarea value={solutionDescription} onChange={e => setSolutionDescription(e.target.value)}
                                        rows="3" placeholder="Ex: Realizada fusão e acomodação dos cabos..."
                                        className="w-full p-3 pr-12 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none appearance-none" />
                                    <button onClick={() => toggleDictation('solution')} type="button"
                                        className={`absolute right-2 bottom-2 p-2 rounded-lg transition-all active:scale-95 ${activeDictationField === 'solution' ? 'bg-red-500 text-white shadow-md animate-pulse' : 'bg-white text-slate-400 border border-slate-200 shadow-sm hover:text-blue-600'}`}>
                                        <Mic className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>

                            {/* Evidence */}
                            <div>
                                <input type="file" id="evidence-upload" accept="image/*" capture="environment" className="hidden" onChange={handleFileChange} />
                                <label htmlFor="evidence-upload" className="flex items-center justify-center gap-3 w-full p-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 font-medium active:bg-slate-50 cursor-pointer hover:bg-slate-50 transition-colors">
                                    {evidence ? (
                                        <>
                                            <CheckCircle className="w-5 h-5 text-green-500" />
                                            <span className="text-green-600 truncate max-w-[200px]">{evidence.name}</span>
                                        </>
                                    ) : (
                                        <>
                                            <Camera className="w-5 h-5" />
                                            Anexar Foto / Evidência
                                        </>
                                    )}
                                </label>
                                {evidence && <button onClick={() => setEvidence(null)} className="mt-2 text-xs text-red-500 font-medium block text-center w-full hover:underline">Remover foto</button>}
                            </div>
                        </section>

                         {/* Bloco C: Controle de Insumos */}
                        <section className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                             <div className="flex items-center gap-2 mb-2">
                                <Box className="w-5 h-5 text-blue-600" />
                                <h3 className="font-bold text-slate-700">Controle de Insumos</h3>
                            </div>

                            {stockItems.length > 0 ? (
                                <ul className="space-y-2">
                                    {stockItems.map((item, idx) => (
                                        <li key={idx} className="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-200">
                                            <span className="font-medium text-slate-700"><span className="font-bold text-blue-600">{item.qty}x</span> {item.name}</span>
                                            <button onClick={() => removeStockItem(idx)} className="text-red-400 p-1"><Trash2 className="w-4 h-4" /></button>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="text-center text-slate-400 text-sm py-2">Nenhum material utilizado.</p>
                            )}

                            <button onClick={() => setIsModalOpen(true)} className="w-full py-3 bg-blue-50 text-blue-700 font-bold rounded-xl border border-blue-100 flex items-center justify-center gap-2 active:bg-blue-100 transition-colors">
                                <PlusCircle className="w-5 h-5" /> ADICIONAR MATERIAL
                            </button>
                        </section>
                    </div>

                    {/* Footer Actions - Standard Flex Child */}
                    <div className="bg-white p-4 border-t border-slate-200 flex gap-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex-shrink-0 z-20">
                        <button onClick={onBack} className="flex-1 bg-slate-100 text-slate-700 font-bold py-4 rounded-xl active:bg-slate-200 transition-colors">
                            CANCELAR
                        </button>
                        <button onClick={handleSubmit} disabled={isSubmitting || !problemDescription || !solutionDescription}
                            className="flex-[2] bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-200 active:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2">
                            {isSubmitting ? 'ENVIANDO...' : 'FINALIZAR CHAMADO'}
                            {!isSubmitting && <CheckCircle className="w-5 h-5" />}
                        </button>
                    </div>

                    {/* Modal Insumos */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm bg-black/40 transition-opacity">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl space-y-4 animate-slide-up ring-1 ring-black/5">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <Box className="w-5 h-5 text-blue-600" /> Adicionar Material
                                </h3>

                                <div>
                                    <label className="block text-sm font-semibold text-slate-500 mb-1">Item</label>
                                    <select value={selectedStockId} onChange={e => setSelectedStockId(e.target.value)}
                                        className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 appearance-none bg-no-repeat bg-right pr-8">
                                        <option value="">Selecione um item...</option>
                                        {availableStock.map(s => (
                                            <option key={s.id} value={s.id}>{s.name}</option>
                                        ))}
                                        <option value="other" className="font-bold text-blue-600">+ Outro Material</option>
                                    </select>
                                </div>

                                {selectedStockId === 'other' && (
                                    <div className="animate-fade-in">
                                        <label className="block text-sm font-semibold text-slate-500 mb-1">Nome do Material</label>
                                        <input type="text" value={customItemName} onChange={e => setCustomItemName(e.target.value)}
                                            placeholder="Digite o nome do item"
                                            className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-semibold text-slate-500 mb-1">Quantidade</label>
                                    <input type="number" min="1" value={stockQty} onChange={e => setStockQty(parseInt(e.target.value))}
                                        inputMode="numeric" pattern="[0-9]*"
                                        className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 text-slate-500 font-bold active:bg-slate-50 rounded-xl transition-colors">Cancelar</button>
                                    <button onClick={handleAddStock} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-transform">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 2. DASHBOARD ---
        function Dashboard({ session, onNavigate, onLogout }) {
            const userName = session?.fullSessionData?.glpifirstname || 'Técnico';

            return (
                <div className="flex-1 flex flex-col relative">
                    {/* Header Minimalista */}
                    <header className="bg-white p-4 flex justify-between items-center shadow-sm z-10">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-700 font-bold">
                                {userName.charAt(0)}
                            </div>
                            <span className="font-semibold text-slate-700 truncate max-w-[150px]">{userName}</span>
                        </div>
                        <button onClick={onLogout} className="text-sm text-slate-500 font-medium px-3 py-1 bg-slate-100 rounded-lg hover:bg-slate-200">
                            Sair
                        </button>
                    </header>

                    {/* Main Content - Center Focus */}
                    <main className="flex-1 flex flex-col items-center justify-center p-6 gap-8">

                        <div className="text-center space-y-2">
                             <h2 className="text-3xl font-black text-slate-800 tracking-tight">O que vamos fazer agora?</h2>
                             <p className="text-slate-500">Selecione uma ação abaixo</p>
                        </div>

                        <button onClick={() => onNavigate('newTicket')}
                            className="w-full max-w-sm aspect-square bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white rounded-3xl shadow-xl shadow-blue-200 flex flex-col items-center justify-center gap-4 transition-all transform touch-btn group">
                            <div className="p-4 bg-white/20 rounded-2xl group-hover:scale-110 transition-transform">
                                {PlusCircle && <PlusCircle className="w-16 h-16 text-white" />}
                            </div>
                            <span className="text-2xl font-bold tracking-wide">NOVO ATENDIMENTO</span>
                        </button>

                         {/* Status Indicator (Fake for now, or check navigator.onLine) */}
                         <div className="absolute bottom-6 left-0 right-0 flex justify-center">
                            <div className={`flex items-center gap-2 px-4 py-2 rounded-full ${navigator.onLine ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                {navigator.onLine ? <Wifi className="w-4 h-4" /> : <WifiOff className="w-4 h-4" />}
                                <span className="text-xs font-bold uppercase">{navigator.onLine ? 'Conectado ao Servidor' : 'Sem Conexão'}</span>
                            </div>
                         </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppWrapper />);
    </script>
</body>
</html>
