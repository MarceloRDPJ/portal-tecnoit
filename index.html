<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TecnoiT - Field Closing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="assets/logo.png">
    <style>
        body { font-family: 'Roboto', sans-serif; -webkit-font-smoothing: antialiased; background-color: #f8fafc; }
        .touch-btn:active { transform: scale(0.98); }
        input, textarea, select { font-size: 16px !important; } /* Prevent iOS zoom */
        .modal-overlay { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">
    <!-- Use 100dvh for better mobile support -->
    <div id="root" class="h-[100dvh] flex flex-col max-w-2xl mx-auto shadow-2xl bg-white"></div>

    <script>
       const firebaseConfig = {
            apiKey: "AIzaSyCh47eM6oXz-vN-2iAZXbDtTIi0CvFe_wY",
            authDomain: "app-tecnoit.firebaseapp.com",
            projectId: "app-tecnoit",
            storageBucket: "app-tecnoit.firebasestorage.app",
            messagingSenderId: "675993906644",
            appId: "1:675993906644:web:90f5fdbbb852a5caa43a41",
            measurementId: "G-MLEH036DLK"
        };
    </script>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        const lucideReactUrl = "https://cdn.skypack.dev/lucide-react";
        let User, Lock, LogIn, PlusCircle, Camera, Mic, Box, Trash2, CheckCircle, XCircle, ChevronDown, Wifi, WifiOff, RefreshCw, Eye, EyeOff;

        // Firebase is kept for potential future use or auth if needed, but the main logic is now Proxy-based
        const firebaseAppUrl = "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        const firebaseAuthUrl = "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        const firestoreUrl = "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        function AppWrapper() {
            const [libsLoaded, setLibsLoaded] = useState(false);
            useEffect(() => {
                Promise.all([import(lucideReactUrl), import(firebaseAppUrl), import(firebaseAuthUrl), import(firestoreUrl)])
                    .then(([lucide, app, auth, firestore]) => {
                        ({ User, Lock, LogIn, PlusCircle, Camera, Mic, Box, Trash2, CheckCircle, XCircle, ChevronDown, Wifi, WifiOff, RefreshCw, Eye, EyeOff } = lucide);
                        window.firebase = { app, auth, firestore };
                        setLibsLoaded(true);
                    }).catch(error => console.error("Falha ao carregar as bibliotecas:", error));
            }, []);

            if (!libsLoaded) return <LoadingScreen message="Iniciando sistema..." />;
            return <App />;
        }

        const APP_VERSION = '1.1.0';

        function App() {
            const { initializeApp } = window.firebase.app;
            const { getAuth, onAuthStateChanged, signInAnonymously } = window.firebase.auth;
            const app = useMemo(() => initializeApp(firebaseConfig), []);
            const auth = useMemo(() => getAuth(app), [app]);

            // App State
            const [view, setView] = useState('login'); // login, dashboard, ticketDetail
            const [user, setUser] = useState(null); // Firebase User
            const [glpiSession, setGlpiSession] = useState(null); // { sessionToken, fullSessionData, glpiUrl }
            const [isLoading, setIsLoading] = useState(true);
            const [selectedTicketId, setSelectedTicketId] = useState(null);

            // Init Firebase Auth (Anonymous for simplicity as we use GLPI Auth)
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
                return () => unsubscribe();
            }, [auth]);

            // Check for saved GLPI Session on startup & Cache Busting
            useEffect(() => {
                const checkSession = async () => {
                   // Check Version to force refresh if needed
                   const savedVersion = localStorage.getItem('appVersion');
                   if (savedVersion !== APP_VERSION) {
                       console.log("New version detected. Clearing old session.");
                       localStorage.removeItem('glpiSessionData');
                       localStorage.setItem('appVersion', APP_VERSION);
                   }

                   const savedCreds = localStorage.getItem('glpiSessionData');
                   if (savedCreds) {
                       try {
                           const parsed = JSON.parse(savedCreds);
                           setGlpiSession(parsed);
                           setView('dashboard');
                       } catch (e) {
                           localStorage.removeItem('glpiSessionData');
                       }
                   }
                   setIsLoading(false);
                };
                if (user) checkSession();
            }, [user]);

            const handleLoginSuccess = (sessionData) => {
                setGlpiSession(sessionData);
                localStorage.setItem('glpiSessionData', JSON.stringify(sessionData));
                setView('dashboard');
            };

            const handleLogout = () => {
                setGlpiSession(null);
                localStorage.removeItem('glpiSessionData');
                setView('login');
            };

            if (isLoading) return <LoadingScreen message="Verificando sessão..." />;

            return (
                <div className="flex flex-col h-full bg-slate-50">
                     {view === 'login' && <LoginScreen onLogin={handleLoginSuccess} />}
                     {view === 'dashboard' && <Dashboard session={glpiSession} onNavigate={(v, id) => { if(id) setSelectedTicketId(id); setView(v); }} onLogout={handleLogout} />}
                     {view === 'ticketDetail' && <TicketDetail session={glpiSession} ticketId={selectedTicketId} onBack={() => setView('dashboard')} />}
                </div>
            );
        }

        const LoadingScreen = ({ message }) => (
             <div className="flex flex-col items-center justify-center h-full bg-slate-50">
                <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p className="text-lg font-medium text-slate-600 animate-pulse">{message}</p>
            </div>
        );

        // --- 1. LOGIN SIMPLIFICADO ---
        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(true);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                const savedUser = localStorage.getItem('glpiUsername');
                if (savedUser) setUsername(savedUser);
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');

                try {
                    const glpiUrl = 'https://suporte.tecnoit.com.br';

                    const res = await fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/initSession', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ glpiUrl, username, password, get_full_session: true })
                    });

                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'Falha na autenticação');

                    if (rememberMe) localStorage.setItem('glpiUsername', username);
                    else localStorage.removeItem('glpiUsername');

                    let fullSession = null;

                    // STRICT CHECK: Ensure glpimy_entities is present.
                    // If the "Fast Login" returns session but NO entities, we MUST fetch full session.
                    if (data.session && data.session.glpimy_entities) {
                        fullSession = data.session;
                    } else {
                        // Fallback to Full Fetch if entities are missing
                        const sessionRes = await fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/getFullSession', {
                            method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ glpiUrl, sessionToken: data.session_token })
                        });

                        if(!sessionRes.ok) throw new Error('Erro ao carregar perfil do usuário');
                        fullSession = (await sessionRes.json()).session;
                    }

                    onLogin({
                        sessionToken: data.session_token,
                        fullSessionData: fullSession,
                        glpiUrl
                    });

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex-1 flex flex-col justify-center p-6 max-w-md mx-auto w-full">
                    <div className="text-center mb-10">
                         <img src="assets/logo.png" alt="Logo" className="h-16 mx-auto mb-4 object-contain" />
                         <h1 className="text-2xl font-bold text-slate-800">Acesso Técnico</h1>
                         <p className="text-slate-500">Field Service</p>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Usuário</label>
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    {User && <User className="h-5 w-5 text-slate-400" />}
                                </div>
                                <input type="text" value={username} onChange={e => setUsername(e.target.value)}
                                    className="pl-10 w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
                                    placeholder="Seu usuário de rede" autoCapitalize="none" autoComplete="username" inputMode="text" required />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Senha</label>
                             <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    {Lock && <Lock className="h-5 w-5 text-slate-400" />}
                                </div>
                                <input type={showPassword ? "text" : "password"} value={password} onChange={e => setPassword(e.target.value)}
                                    className="pl-10 pr-12 w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
                                    placeholder="Sua senha" autoComplete="current-password" required />
                                <button type="button" onClick={() => setShowPassword(!showPassword)}
                                    className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-600 focus:outline-none">
                                    {showPassword ? (EyeOff && <EyeOff className="h-5 w-5"/>) : (Eye && <Eye className="h-5 w-5"/>)}
                                </button>
                            </div>
                        </div>

                        <div className="flex items-center">
                            <input id="remember-me" type="checkbox" checked={rememberMe} onChange={e => setRememberMe(e.target.checked)}
                                className="h-5 w-5 text-blue-600 rounded border-slate-300 focus:ring-blue-500" />
                            <label htmlFor="remember-me" className="ml-2 block text-sm text-slate-700 font-medium">Lembrar meu usuário</label>
                        </div>

                        {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium text-center">{error}</div>}

                        <button type="submit" disabled={loading}
                            className="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 touch-btn flex items-center justify-center transition-all disabled:opacity-70">
                            {loading ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <span className="flex items-center gap-2 text-lg">ENTRAR {LogIn && <LogIn className="w-5 h-5" />}</span>}
                        </button>
                    </form>
                </div>
            );
        }

        // --- 3. TICKET DETAIL & RESPONSE ---
        function TicketDetail({ session, ticketId, onBack }) {
            const { sessionToken, glpiUrl } = session;
            const [ticket, setTicket] = useState(null);
            const [loading, setLoading] = useState(true);
            const [responseContent, setResponseContent] = useState('');
            const [evidence, setEvidence] = useState(null);

            // Stock Logic (Reused)
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [stockItems, setStockItems] = useState([]);
            const [availableStock, setAvailableStock] = useState([]);
            const [selectedStockId, setSelectedStockId] = useState('');
            const [customItemName, setCustomItemName] = useState('');
            const [stockQty, setStockQty] = useState(1);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [activeDictationField, setActiveDictationField] = useState(null);

            // Fetch Detail
            useEffect(() => {
                const load = async () => {
                    try {
                        const res = await fetch(`https://portal-tecnoit-glpi.onrender.com/api/proxy/getTicketDetails/${ticketId}`, {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ glpiUrl, sessionToken })
                        });
                        if(res.ok) setTicket(await res.json());
                    } catch(e) { console.error(e); } finally { setLoading(false); }
                };
                load();

                // Fetch Stock
                fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/getConsumables', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ glpiUrl, sessionToken })
                }).then(r => r.json()).then(setAvailableStock).catch(console.error);

            }, [ticketId]);

            // Handlers for Stock (Same as before)
            const handleAddStock = () => {
                 if (!selectedStockId || stockQty <= 0) return;
                 let itemName = '', itemId = selectedStockId;
                 if (selectedStockId === 'other') {
                     if (!customItemName.trim()) return alert("Digite o nome.");
                     itemName = customItemName; itemId = 'custom-' + Date.now();
                 } else {
                     const item = availableStock.find(s => String(s.id) === String(selectedStockId));
                     if (!item) return; itemName = item.name;
                 }
                 setStockItems(prev => [...prev, { id: itemId, name: itemName, qty: stockQty }]);
                 setSelectedStockId(''); setCustomItemName(''); setStockQty(1); setIsModalOpen(false);
            };

            const handleSubmit = async (status) => {
                if(!responseContent) return alert("Digite uma resposta.");
                setIsSubmitting(true);
                try {
                    let content = responseContent;

                    // Add Evidence Text
                    if(evidence) content += `<br>[Evidência Anexada]`; // Real upload would go here

                    const payload = {
                        glpiUrl, sessionToken, ticketId,
                        content, status,
                        stockItems,
                        entities_id: ticket.entities_id // Important for custom items
                    };

                    await fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/respondTicket', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    alert("Resposta enviada!");
                    onBack();
                } catch(e) { alert("Erro: " + e.message); } finally { setIsSubmitting(false); }
            };

            if(loading) return <LoadingScreen message="Carregando chamado..." />;
            if(!ticket) return <div className="p-4">Erro ao carregar. <button onClick={onBack}>Voltar</button></div>;

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    {/* Header */}
                    <div className="bg-white p-4 shadow-sm flex items-center gap-4 z-20">
                         <button onClick={onBack} className="p-2 -ml-2 text-slate-500 rounded-full"><ChevronDown className="w-6 h-6 rotate-90" /></button>
                         <div>
                             <h2 className="text-lg font-bold text-slate-800 leading-tight">Chamado #{ticket.id}</h2>
                             <p className="text-xs text-slate-500">{ticket.name}</p>
                         </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {/* Info Card */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                             <div className="flex justify-between mb-2">
                                <span className="text-xs font-bold px-2 py-1 bg-blue-100 text-blue-700 rounded-md">Status: {ticket.status}</span>
                                <span className="text-xs text-slate-400">{ticket.date}</span>
                             </div>
                             <div className="text-sm text-slate-600" dangerouslySetInnerHTML={{__html: ticket.content}} />
                        </div>

                        {/* Response Form */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 space-y-3">
                            <h3 className="font-bold text-slate-700 flex items-center gap-2"><RefreshCw className="w-4 h-4"/> Minha Resposta</h3>
                            <textarea value={responseContent} onChange={e => setResponseContent(e.target.value)}
                                className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 h-32 outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Descreva a solução ou andamento..." />

                             {/* Evidence */}
                             <input type="file" className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>

                        {/* Stock */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 space-y-3">
                             <div className="flex justify-between items-center">
                                 <h3 className="font-bold text-slate-700 flex items-center gap-2"><Box className="w-4 h-4"/> Insumos</h3>
                                 <button onClick={() => setIsModalOpen(true)} className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">+ Add</button>
                             </div>
                             {stockItems.map((item, i) => (
                                 <div key={i} className="flex justify-between text-sm p-2 bg-slate-50 rounded border border-slate-100">
                                     <span>{item.qty}x {item.name}</span>
                                     <span className="text-red-500" onClick={() => setStockItems(p => p.filter((_, idx) => idx !== i))}>X</span>
                                 </div>
                             ))}
                        </div>
                    </div>

                    {/* Footer Actions */}
                    <div className="bg-white p-4 border-t border-slate-200 flex gap-2 shadow-lg z-20">
                        <button onClick={() => handleSubmit(2)} disabled={isSubmitting} className="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-xl">RESPONDER (AGUARDAR)</button>
                        <button onClick={() => handleSubmit(5)} disabled={isSubmitting} className="flex-1 bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-200">SOLUCIONAR</button>
                    </div>

                    {/* Stock Modal (Simplified) */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 space-y-4">
                                <h3>Adicionar Insumo</h3>
                                <select value={selectedStockId} onChange={e => setSelectedStockId(e.target.value)} className="w-full p-3 border rounded-xl">
                                    <option value="">Selecione...</option>
                                    {availableStock.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                    <option value="other">Outro...</option>
                                </select>
                                {selectedStockId === 'other' && <input value={customItemName} onChange={e => setCustomItemName(e.target.value)} placeholder="Nome" className="w-full p-3 border rounded-xl" />}
                                <input type="number" value={stockQty} onChange={e => setStockQty(e.target.value)} className="w-full p-3 border rounded-xl" />
                                <div className="flex gap-2">
                                    <button onClick={() => setIsModalOpen(false)} className="flex-1 p-3 bg-slate-100 rounded-xl">Cancelar</button>
                                    <button onClick={handleAddStock} className="flex-1 p-3 bg-blue-600 text-white rounded-xl">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 2. DASHBOARD (Ticket List) ---
        function Dashboard({ session, onNavigate, onLogout }) {
            const { sessionToken, fullSessionData, glpiUrl } = session;
            const userName = fullSessionData?.glpifirstname || 'Técnico';

            const [tickets, setTickets] = useState([]);
            const [filter, setFilter] = useState('new'); // new (Processando), pending, solved
            const [loading, setLoading] = useState(true);

            // Fetch Tickets
            useEffect(() => {
                const load = async () => {
                    setLoading(true);
                    try {
                        const res = await fetch('https://portal-tecnoit-glpi.onrender.com/api/proxy/getTickets', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ glpiUrl, sessionToken, range: '0-50' })
                        });
                        const data = await res.json();
                        setTickets(data.tickets || []);
                    } catch(e) { console.error(e); } finally { setLoading(false); }
                };
                load();
            }, [glpiUrl, sessionToken]);

            // Simple Filter Logic (Client-side for prototype)
            // GLPI Status: 1=New, 2=Assign, 3=Plan, 4=Wait, 5=Solved, 6=Closed
            const filteredTickets = tickets.filter(t => {
                const s = t.status;
                if(filter === 'new') return (s === 1 || s === 2 || s === 3); // Em atendimento
                if(filter === 'pending') return s === 4; // Pendente
                if(filter === 'solved') return (s === 5 || s === 6); // Solucionado
                return true;
            });

            return (
                <div className="flex-1 flex flex-col h-full bg-slate-50">
                    <header className="bg-white p-4 shadow-sm z-10 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                             <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-700 font-bold">{userName.charAt(0)}</div>
                             <span className="font-bold text-slate-700">{userName}</span>
                        </div>
                        <button onClick={onLogout} className="text-xs bg-slate-100 px-3 py-1 rounded-full">Sair</button>
                    </header>

                    {/* Filter Tabs */}
                    <div className="flex p-2 gap-2 overflow-x-auto bg-white border-b border-slate-100">
                        {[
                            {id: 'new', label: 'Em Andamento'},
                            {id: 'pending', label: 'Pendentes'},
                            {id: 'solved', label: 'Finalizados'}
                        ].map(tab => (
                            <button key={tab.id} onClick={() => setFilter(tab.id)}
                                className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${filter === tab.id ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-500'}`}>
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {/* List */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {loading ? <p className="text-center text-slate-400 mt-10">Carregando chamados...</p> : (
                            filteredTickets.length === 0 ? <p className="text-center text-slate-400 mt-10">Nenhum chamado encontrado.</p> :
                            filteredTickets.map(t => (
                                <div key={t.id} onClick={() => onNavigate('ticketDetail', t.id)}
                                    className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 active:scale-98 transition-transform cursor-pointer">
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="font-bold text-slate-800 text-sm line-clamp-1">{t.name}</span>
                                        <span className="text-xs font-mono text-slate-400">#{t.id}</span>
                                    </div>
                                    <p className="text-xs text-slate-500 mb-2 line-clamp-2" dangerouslySetInnerHTML={{__html: t.content}}></p>
                                    <div className="flex gap-2 text-xs">
                                        <span className="bg-slate-100 px-2 py-1 rounded text-slate-600">{t.date_mod || t.date}</span>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppWrapper />);
    </script>
</body>
</html>
