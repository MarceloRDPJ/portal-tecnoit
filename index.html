<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tecno iT - Portal de Chamados</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
  </style>
  <script src="https://cdn.tailwindcss.com/3.4.1"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            poppins: ['Poppins', 'sans-serif'],
          },
          colors: {
            'tecnoit-bg': '#1a2035',
            'tecnoit-bg-light': '#2a314b',
            'tecnoit-orange': '#ff5a00',
            'tecnoit-orange-hover': '#e65100',
            'tecnoit-text': '#d0d2d6',
            'tecnoit-text-light': '#a0a4b1',
          },
        },
      },
    };
  </script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>

<body class="bg-tecnoit-bg text-tecnoit-text font-poppins">
  <div id="root"></div>

  <script type="text/babel">
      // Firebase variables will be initialized later
      let initializeApp, getAuth, signInAnonymously, getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, serverTimestamp;

      // --- Ícones SVG embutidos como componentes React ---
      const SvgIcon = ({ className, children }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
        >
          {children}
        </svg>
      );

      const LoaderCircle = ({ className }) => <SvgIcon className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></SvgIcon>;
      const Ticket = ({ className }) => <SvgIcon className={className}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z" /><path d="M13 5v2" /><path d="M13 17v2" /><path d="M13 11v2" /></SvgIcon>;
      const LayoutGrid = ({ className }) => <SvgIcon className={className}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></SvgIcon>;
      const MessageSquare = ({ className }) => <SvgIcon className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></SvgIcon>;
      const CheckSquare = ({ className }) => <SvgIcon className={className}><polyline points="9 11 12 14 22 4" /><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" /></SvgIcon>;
      const ArrowLeft = ({ className }) => <SvgIcon className={className}><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></SvgIcon>;
      const RefreshCw = ({ className }) => <SvgIcon className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M3 21v-5h5" /></SvgIcon>;
      const LogOut = ({ className }) => <SvgIcon className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></SvgIcon>;


      // Mapeamento de status e prioridades do GLPI
      const GLPI_STATUSES = { 1: 'Novo', 2: 'Em Atendimento', 3: 'Em Atendimento (planejado)', 4: 'Pendente', 5: 'Solucionado', 6: 'Fechado' };
      const GLPI_PRIORITIES = { 1: 'Muito Baixa', 2: 'Baixa', 3: 'Média', 4: 'Alta', 5: 'Muito Alta', 6: 'Urgente' };

      // --- Início do Bloco de Configuração do Firebase ---
      const firebaseConfig = {
        apiKey: "AIzaSyCh47eM6oXz-vN-2iAZXbDtTIi0CvFe_wY",
        authDomain: "app-tecnoit.firebaseapp.com",
        projectId: "app-tecnoit",
        storageBucket: "app-tecnoit.appspot.com",
        messagingSenderId: "675993906644",
        appId: "1:675993906644:web:90f5fdbbb852a5caa43a41",
        measurementId: "G-MLEH036DLK"
      };
      // --- Fim do Bloco de Configuração do Firebase ---

      let app;
      let auth;
      let db;
      let userId;

      // Função para inicializar o Firebase e autenticar
      async function initFirebase() {
          try {
              if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined' || typeof firebase.getAuth === 'undefined' || typeof firebase.getFirestore === 'undefined') {
                  throw new Error("Firebase SDK não foi carregado corretamente.");
              }
              // Assign functions directly from the firebase global
              initializeApp = firebase.initializeApp;
              getAuth = firebase.getAuth;
              signInAnonymously = firebase.signInAnonymously;
              getFirestore = firebase.getFirestore;
              doc = firebase.doc;
              setDoc = firebase.setDoc;
              getDoc = firebase.getDoc;
              collection = firebase.collection;
              addDoc = firebase.addDoc;
              onSnapshot = firebase.onSnapshot;
              query = firebase.query;
              serverTimestamp = firebase.serverTimestamp;

              if (!firebaseConfig || !firebaseConfig.apiKey) {
                  throw new Error("Configuração do Firebase não encontrada.");
              }
              app = initializeApp(firebaseConfig);
              auth = getAuth(app);
              db = getFirestore(app);
              await signInAnonymously(auth);
              userId = auth.currentUser.uid;
              console.log("Usuário autenticado anonimamente:", userId);
              return { app, auth, db, userId };
          } catch (error) {
              console.error("Erro na inicialização ou autenticação do Firebase:", error);
              throw error;
          }
      }


      // Componente principal da aplicação
      class App extends React.Component {
          constructor(props) {
              super(props);
              this.state = {
                  currentView: 'glpi',
                  hasError: false,
                  error: null,
                  errorInfo: null,
              };
          }
          
          static getDerivedStateFromError(error) {
              return { hasError: true, error: error };
          }

          componentDidCatch(error, errorInfo) {
              console.error("Erro capturado pelo ErrorBoundary:", error, errorInfo);
              this.setState({ errorInfo: errorInfo });
          }
          
          render() {
              if (this.state.hasError) {
                  return (
                      <div style={{ color: 'white', padding: '20px', fontFamily: 'monospace', backgroundColor: '#1a2035', height: '100vh' }}>
                          <h1 style={{ fontSize: '24px' }}>Ocorreu um Erro Crítico</h1>
                          <pre style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-all', marginTop: '10px' }}>
                              {this.state.error && this.state.error.toString()}
                          </pre>
                          {this.state.errorInfo && (
                              <pre style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-all', marginTop: '10px' }}>
                                  {this.state.errorInfo.componentStack}
                              </pre>
                          )}
                      </div>
                  );
              }

              return (
                  <div className="flex h-screen bg-tecnoit-bg font-poppins">
                      <Sidebar currentView={this.state.currentView} setCurrentView={(view) => this.setState({ currentView: view })} />
                      <main className="flex-1 p-8 overflow-y-auto">
                          <Header />
                          {this.state.currentView === 'glpi' && <GlpiTickets />}
                          {this.state.currentView === 'painel' && <h2 className="text-2xl font-semibold">Painel em desenvolvimento</h2>}
                          {this.state.currentView === 'chat' && <Chat />}
                          {this.state.currentView === 'tarefas' && <Tasks />}
                      </main>
                  </div>
              );
          }
      }

      // --- Componentes da Interface ---

      function Sidebar({ currentView, setCurrentView }) {
          const navItems = [
              { id: 'glpi', label: 'Chamados GLPI', icon: Ticket },
              { id: 'painel', label: 'Painel', icon: LayoutGrid },
              { id: 'chat', label: 'Chat', icon: MessageSquare },
              { id: 'tarefas', label: 'Tarefas', icon: CheckSquare },
          ];

          const logoIcon = (
              <div className="bg-tecnoit-orange rounded-full w-10 h-10 flex items-center justify-center">
                  <span className="text-white text-xl font-bold italic">iT</span>
              </div>
          );

          return (
              <aside className="w-64 bg-tecnoit-bg-light p-6 flex flex-col">
                  <div className="flex items-center gap-3 mb-10">
                      {logoIcon}
                      <h1 className="text-2xl font-bold">Tecno iT</h1>
                  </div>
                  <nav className="flex flex-col gap-2">
                      {navItems.map(item => (
                          <button
                              key={item.id}
                              onClick={() => setCurrentView(item.id)}
                              className={`flex items-center gap-3 p-3 rounded-lg text-left transition-colors ${currentView === item.id ? 'bg-tecnoit-orange text-white' : 'hover:bg-tecnoit-bg'}`}
                          >
                              <item.icon className="h-5 w-5" />
                              {item.label}
                          </button>
                      ))}
                  </nav>
              </aside>
          );
      }


      function Header() {
        return (
          <header className="mb-8">
            <h1 className="text-3xl font-bold">Bem-vindo(a) de volta!</h1>
            <p className="text-tecnoit-text-light">Pronto para um dia produtivo?</p>
          </header>
        );
      }
      
      // --- Seção GLPI ---

      function GlpiTickets() {
          const [glpiConfig, setGlpiConfig] = React.useState(null);
          const [sessionToken, setSessionToken] = React.useState(null);
          const [tickets, setTickets] = React.useState([]);
          const [loading, setLoading] = React.useState(true);
          const [error, setError] = React.useState('');
          const [selectedTicket, setSelectedTicket] = React.useState(null);
          
          React.useEffect(() => {
              if (!db || !userId) return;
              const configRef = doc(db, `artifacts/${app.options.appId}/users/${userId}/glpiConfig`, 'config');
              const unsubscribe = onSnapshot(configRef, (docSnap) => {
                  if (docSnap.exists()) {
                      const config = docSnap.data();
                      setGlpiConfig(config);
                      if (config.sessionToken) {
                          setSessionToken(config.sessionToken);
                      }
                  }
                  setLoading(false);
              });
              return () => unsubscribe();
          }, []);

          const handleConnect = async (authDetails) => {
              setLoading(true);
              setError('');
              try {
                  const response = await fetch('https://tecnoit-glpi-proxy.onrender.com/api/proxy/initSession', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(authDetails),
                  });
                  const data = await response.json();
                  
                  if (response.ok) {
                      setSessionToken(data.session_token);
                      const configRef = doc(db, `artifacts/${app.options.appId}/users/${userId}/glpiConfig`, 'config');
                      const newConfig = {
                          glpiUrl: authDetails.glpiUrl,
                          sessionToken: data.session_token,
                          ...(authDetails.apiToken && { apiToken: authDetails.apiToken }),
                          ...(authDetails.username && { username: authDetails.username }),
                      };
                      await setDoc(configRef, newConfig, { merge: true });

                  } else {
                      throw new Error(data.error || 'Falha ao iniciar sessão no GLPI.');
                  }
              } catch (err) {
                   console.error("Erro de conexão:", err);
                   setError(`Falha na conexão: ${err.message}. Verifique a URL, as credenciais e se o serviço de back-end está no ar.`);
              } finally {
                  setLoading(false);
              }
          };

          const fetchTickets = async () => {
               if (!sessionToken || !glpiConfig) return;
               setLoading(true);
               setError('');
               try {
                  const response = await fetch('https://tecnoit-glpi-proxy.onrender.com/api/proxy/getTickets', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                          glpiUrl: glpiConfig.glpiUrl,
                          sessionToken: sessionToken
                      }),
                  });
                  const data = await response.json();
                  if (response.ok) {
                      setTickets(data);
                  } else {
                      throw new Error(data.error || 'Falha ao buscar chamados.');
                  }
              } catch (err) {
                  console.error("Erro ao buscar chamados:", err);
                  setError(err.message);
                  if (err.message.includes('TOKEN_INVALID')) {
                      handleLogout();
                  }
              } finally {
                  setLoading(false);
              }
          };
          
          React.useEffect(() => {
              if (sessionToken && glpiConfig) {
                  fetchTickets();
              }
          }, [sessionToken, glpiConfig]);
          
          const handleLogout = async () => {
              const configRef = doc(db, `artifacts/${app.options.appId}/users/${userId}/glpiConfig`, 'config');
              await setDoc(configRef, { sessionToken: null }, { merge: true });
              setSessionToken(null);
              setTickets([]);
              setSelectedTicket(null);
          };

          const handleTicketAction = async (ticketId, actionType, content) => {
              setLoading(true);
              try {
                  const response = await fetch('https://tecnoit-glpi-proxy.onrender.com/api/proxy/addTicketAction', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                          glpiUrl: glpiConfig.glpiUrl,
                          sessionToken,
                          ticketId,
                          actionType,
                          content
                      }),
                  });
                  const data = await response.json();
                  if (response.ok) {
                      fetchTickets(); 
                      setSelectedTicket(prev => ({...prev, ...data.updatedTicketData}));
                  } else {
                      throw new Error(data.error || `Falha ao adicionar ${actionType}`);
                  }
              } catch (err) {
                  console.error(`Erro em ${actionType}:`, err);
                  setError(err.message);
              } finally {
                  setLoading(false);
              }
          };

          if (loading && !glpiConfig) {
              return <div className="flex items-center justify-center h-full"><LoaderCircle className="animate-spin h-8 w-8 text-tecnoit-orange" /></div>;
          }

          if (!sessionToken) {
              return <ConnectionForm onConnect={handleConnect} loading={loading} error={error} />;
          }

          if (selectedTicket) {
              return <TicketDetail 
                  ticket={selectedTicket} 
                  onBack={() => setSelectedTicket(null)}
                  onAddFollowup={(content) => handleTicketAction(selectedTicket.id, 'ITILFollowup', content)}
                  onAddSolution={(content) => handleTicketAction(selectedTicket.id, 'ITILSolution', content)}
                  loading={loading}
              />;
          }

          return <TicketList tickets={tickets} loading={loading} error={error} onSelectTicket={setSelectedTicket} onLogout={handleLogout} onRefresh={fetchTickets} />;
      }

      function ConnectionForm({ onConnect, loading, error }) {
          const [loginType, setLoginType] = React.useState('token');
          const [apiToken, setApiToken] = React.useState('');
          const [username, setUsername] = React.useState('');
          const [password, setPassword] = React.useState('');

          const handleSubmit = (e) => {
              e.preventDefault();
              const glpiUrl = "https://suporte.tecnoit.com.br";
              let authDetails = { glpiUrl };

              if (loginType === 'token') {
                  authDetails.apiToken = apiToken;
              } else {
                  authDetails.username = username;
                  authDetails.password = password;
              }
              onConnect(authDetails);
          };
          
          const logoIcon = (
              <div className="mx-auto bg-tecnoit-orange rounded-full w-12 h-12 flex items-center justify-center mb-4">
                  <span className="text-white text-2xl font-bold italic">iT</span>
              </div>
          );

          return (
              <div className="max-w-md mx-auto mt-10 p-8 bg-tecnoit-bg-light rounded-2xl shadow-lg">
                  {logoIcon}
                  <h2 className="text-2xl font-bold text-center mb-2">Conectar ao GLPI</h2>
                  <p className="text-center text-tecnoit-text-light mb-6">Insira seus dados para visualizar os chamados.</p>
                  <div className="mb-4 flex justify-center bg-tecnoit-bg p-1 rounded-lg">
                      <button
                          onClick={() => setLoginType('token')}
                          className={`px-4 py-2 text-sm font-semibold rounded-md transition ${loginType === 'token' ? 'bg-tecnoit-orange text-white' : 'text-tecnoit-text-light'}`}
                      >API Token</button>
                      <button
                          onClick={() => setLoginType('credentials')}
                          className={`px-4 py-2 text-sm font-semibold rounded-md transition ${loginType === 'credentials' ? 'bg-tecnoit-orange text-white' : 'text-tecnoit-text-light'}`}
                      >Usuário & Senha</button>
                  </div>
                  <form onSubmit={handleSubmit}>
                      <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">URL da Instância GLPI</label>
                          <input
                              type="text"
                              readOnly
                              value="https://suporte.tecnoit.com.br"
                              className="w-full p-3 bg-tecnoit-bg rounded-lg border border-gray-600 focus:ring-tecnoit-orange focus:border-tecnoit-orange cursor-not-allowed text-gray-400"
                          />
                      </div>

                      {loginType === 'token' ? (
                          <div className="mb-6">
                              <label className="block text-sm font-medium mb-2">Seu App-Token</label>
                              <input
                                  type="password"
                                  value={apiToken}
                                  onChange={(e) => setApiToken(e.target.value)}
                                  placeholder="Token de acesso da API"
                                  className="w-full p-3 bg-tecnoit-bg rounded-lg border border-gray-600 focus:ring-tecnoit-orange focus:border-tecnoit-orange"
                              />
                          </div>
                      ) : (
                          <React.Fragment>
                              <div className="mb-4">
                                  <label className="block text-sm font-medium mb-2">Usuário</label>
                                  <input
                                      type="text"
                                      value={username}
                                      onChange={(e) => setUsername(e.target.value)}
                                      placeholder="Seu usuário do GLPI"
                                      className="w-full p-3 bg-tecnoit-bg rounded-lg border border-gray-600 focus:ring-tecnoit-orange focus:border-tecnoit-orange"
                                  />
                              </div>
                              <div className="mb-6">
                                  <label className="block text-sm font-medium mb-2">Senha</label>
                                  <input
                                      type="password"
                                      value={password}
                                      onChange={(e) => setPassword(e.target.value)}
                                      placeholder="Sua senha"
                                      className="w-full p-3 bg-tecnoit-bg rounded-lg border border-gray-600 focus:ring-tecnoit-orange focus:border-tecnoit-orange"
                                  />
                              </div>
                          </React.Fragment>
                      )}
                      
                      <button
                          type="submit"
                          disabled={loading}
                          className="w-full bg-tecnoit-orange text-white font-bold py-3 px-4 rounded-lg hover:bg-tecnoit-orange-hover transition-colors flex items-center justify-center"
                      >
                          {loading ? <LoaderCircle className="animate-spin h-5 w-5" /> : 'Conectar'}
                      </button>
                      {error && <p className="text-red-400 text-sm mt-4 text-center">{error}</p>}
                  </form>
              </div>
          );
      }
      
      function TicketList({ tickets, loading, error, onSelectTicket, onLogout, onRefresh }) {
          return (
              <div>
                  <div className="flex justify-between items-center mb-4">
                      <h2 className="text-2xl font-semibold">Meus Chamados</h2>
                      <div className="flex items-center gap-2">
                          <button onClick={onRefresh} className="p-2 rounded-lg bg-tecnoit-bg-light hover:bg-tecnoit-bg" disabled={loading}>
                              <RefreshCw className={`h-5 w-5 ${loading ? 'animate-spin' : ''}`} />
                          </button>
                          <button onClick={onLogout} className="p-2 rounded-lg bg-red-800 hover:bg-red-700 text-white flex items-center gap-2 text-sm px-3">
                               <LogOut className="h-4 w-4" /> Sair
                          </button>
                      </div>
                  </div>
                  {error && <p className="text-red-400">{error}</p>}
                  {loading && tickets.length === 0 ? (
                      <div className="text-center py-10">
                          <LoaderCircle className="animate-spin h-8 w-8 text-tecnoit-orange mx-auto" />
                          <p className="mt-2 text-tecnoit-text-light">Carregando chamados...</p>
                      </div>
                  ) : (
                      <div className="bg-tecnoit-bg-light rounded-lg">
                          <table className="w-full text-left">
                              <thead>
                                  <tr className="border-b border-tecnoit-bg">
                                      <th className="p-4">ID</th>
                                      <th className="p-4">Título</th>
                                      <th className="p-4">Status</th>
                                      <th className="p-4">Prioridade</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {tickets.map(ticket => (
                                      <tr
                                          key={ticket.id}
                                          onClick={() => onSelectTicket(ticket)}
                                          className="hover:bg-tecnoit-bg cursor-pointer border-b border-tecnoit-bg last:border-b-0"
                                      >
                                          <td className="p-4">{ticket.id}</td>
                                          <td className="p-4">{ticket.name}</td>
                                          <td className="p-4">{GLPI_STATUSES[ticket.status] || ticket.status}</td>
                                          <td className="p-4">
                                              <span className={`px-2 py-1 text-xs rounded-full ${
                                                  ticket.priority >= 4 ? 'bg-red-500 text-white' : 
                                                  ticket.priority === 3 ? 'bg-yellow-500 text-black' : 'bg-gray-500 text-white'
                                              }`}>
                                              {GLPI_PRIORITIES[ticket.priority] || ticket.priority}
                                              </span>
                                          </td>
                                      </tr>
                                  ))}
                              </tbody>
                          </table>
                      </div>
                  )}
              </div>
          );
      }
      
      function TicketDetail({ ticket, onBack, onAddFollowup, onAddSolution, loading }) {
          const [newItemContent, setNewItemContent] = React.useState('');
          const [actionType, setActionType] = React.useState('followup');
      
          const handleSubmit = (e) => {
              e.preventDefault();
              if (!newItemContent.trim()) return;
              if (actionType === 'followup') {
                  onAddFollowup(newItemContent);
              } else {
                  onAddSolution(newItemContent);
              }
              setNewItemContent('');
          };
      
          return (
              <div>
                  <button onClick={onBack} className="flex items-center gap-2 mb-4 text-tecnoit-text-light hover:text-white">
                      <ArrowLeft className="h-4 w-4" />
                      Voltar para a lista
                  </button>
                  <div className="bg-tecnoit-bg-light p-6 rounded-lg">
                      <h2 className="text-2xl font-bold mb-1">{`Chamado #${ticket.id}: ${ticket.name}`}</h2>
                      <div dangerouslySetInnerHTML={{ __html: ticket.content }} />
                      <hr className="my-4 border-gray-700" />
                      <h3 className="text-lg font-semibold mt-6 mb-4">Adicionar Interação</h3>
                      <form onSubmit={handleSubmit}>
                          <div className="mb-2 flex items-center gap-4">
                              <label>
                                 <input type="radio" name="actionType" value="followup" checked={actionType === 'followup'} onChange={() => setActionType('followup')} />
                                  Acompanhamento
                              </label>
                              <label>
                                 <input type="radio" name="actionType" value="solution" checked={actionType === 'solution'} onChange={() => setActionType('solution')} />
                                  Solução
                              </label>
                          </div>
                          <textarea
                              value={newItemContent}
                              onChange={(e) => setNewItemContent(e.target.value)}
                              placeholder={actionType === 'followup' ? 'Descreva o acompanhamento...' : 'Descreva a solução...'}
                              className="w-full p-3 bg-tecnoit-bg rounded-lg border border-gray-600 focus:ring-tecnoit-orange focus:border-tecnoit-orange min-h-[100px]"
                          />
                          <button
                              type="submit"
                              disabled={loading}
                              className="mt-2 bg-tecnoit-orange text-white font-bold py-2 px-4 rounded-lg hover:bg-tecnoit-orange-hover transition-colors flex items-center justify-center"
                          >
                              {loading ? <LoaderCircle className="animate-spin h-5 w-5" /> : 'Adicionar'}
                          </button>
                      </form>
                  </div>
              </div>
          );
      }


      // --- Seção de Chat ---
      function Chat() {
          const [messages, setMessages] = React.useState([]);
          const [newMessage, setNewMessage] = React.useState('');
          const messagesEndRef = React.useRef(null);

          React.useEffect(() => {
              if (!db || !userId) return;
              const messagesCol = collection(db, `artifacts/${app.options.appId}/public/data/chat`);
              const q = query(messagesCol);
              const unsubscribe = onSnapshot(q, (querySnapshot) => {
                  const msgs = [];
                  querySnapshot.forEach((doc) => {
                      msgs.push({ id: doc.id, ...doc.data() });
                  });
                  msgs.sort((a, b) => a.timestamp?.toMillis() - b.timestamp?.toMillis());
                  setMessages(msgs);
              });
              return () => unsubscribe();
          }, []);

          React.useEffect(() => {
              messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          }, [messages]);

          const handleSendMessage = async (e) => {
              e.preventDefault();
              if (newMessage.trim() === '') return;
              const messagesCol = collection(db, `artifacts/${app.options.appId}/public/data/chat`);
              await addDoc(messagesCol, {
                  text: newMessage,
                  timestamp: serverTimestamp(),
                  uid: userId,
              });
              setNewMessage('');
          };
          
          const Message = ({ msg }) => {
              const isMe = msg.uid === userId;
              return (
                  <div className={`flex ${isMe ? 'justify-end' : 'justify-start'} mb-4`}>
                      <div className={`max-w-xs md:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl ${isMe ? 'bg-tecnoit-orange text-white rounded-br-none' : 'bg-tecnoit-bg-light rounded-bl-none'}`}>
                          <p className="text-sm">{msg.text}</p>
                      </div>
                  </div>
              );
          };


          return (
              <div className="flex flex-col h-full max-h-[calc(100vh-150px)]">
                  <h2 className="text-2xl font-semibold mb-4">Chat da Equipe</h2>
                  <div className="flex-1 bg-tecnoit-bg-light p-4 rounded-lg overflow-y-auto">
                      {messages.map(msg => <Message key={msg.id} msg={msg} />)}
                      <div ref={messagesEndRef} />
                  </div>
                  <form onSubmit={handleSendMessage} className="mt-4 flex gap-3">
                      <input
                          type="text"
                          value={newMessage}
                          onChange={(e) => setNewMessage(e.target.value)}
                          placeholder="Digite sua mensagem..."
                          className="flex-1 p-3 bg-tecnoit-bg-light rounded-lg border border-transparent focus:ring-2 focus:ring-tecnoit-orange focus:border-transparent"
                      />
                      <button type="submit" className="bg-tecnoit-orange text-white font-bold py-3 px-6 rounded-lg hover:bg-tecnoit-orange-hover transition-colors">Enviar</button>
                  </form>
              </div>
          );
      }

      // --- Seção de Tarefas ---
      function Tasks() {
          const [tasks, setTasks] = React.useState([]);
          const [newTask, setNewTask] = React.useState('');

          React.useEffect(() => {
               if (!db || !userId) return;
               const tasksCol = collection(db, `artifacts/${app.options.appId}/users/${userId}/tasks`);
               const q = query(tasksCol);
               const unsubscribe = onSnapshot(q, (snapshot) => {
                   const userTasks = [];
                   snapshot.forEach(doc => userTasks.push({ id: doc.id, ...doc.data() }));
                   setTasks(userTasks);
               });
               return () => unsubscribe();
          }, []);

          const handleAddTask = async (e) => {
              e.preventDefault();
              if (newTask.trim() === '') return;
               const tasksCol = collection(db, `artifacts/${app.options.appId}/users/${userId}/tasks`);
              await addDoc(tasksCol, { text: newTask, completed: false, createdAt: serverTimestamp() });
              setNewTask('');
          };
          
          return (
              <div>
                  <h2 className="text-2xl font-semibold mb-4">Minhas Tarefas</h2>
                  <form onSubmit={handleAddTask} className="flex gap-3 mb-4">
                      <input
                          type="text"
                          value={newTask}
                          onChange={(e) => setNewTask(e.target.value)}
                          placeholder="Adicionar nova tarefa..."
                          className="flex-1 p-3 bg-tecnoit-bg-light rounded-lg border border-transparent focus:ring-2 focus:ring-tecnoit-orange focus:border-transparent"
                      />
                      <button type="submit" className="bg-tecnoit-orange text-white font-bold py-3 px-6 rounded-lg hover:bg-tecnoit-orange-hover transition-colors">Adicionar</button>
                  </form>
                  <div className="space-y-2">
                      {tasks.map(task => (
                          <div key={task.id} className="bg-tecnoit-bg-light p-3 rounded-lg flex items-center">
                              <p className="flex-1">{task.text}</p>
                          </div>
                      ))}
                  </div>
              </div>
          );
      }
      
      // --- Application Entry Point ---
      const renderError = (error) => {
          const root = ReactDOM.createRoot(document.getElementById("root"));
          root.render(
              <div style={{ color: 'white', padding: '20px', fontFamily: 'monospace', backgroundColor: '#1a2035', height: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                  <div style={{ maxWidth: '800px', border: '1px solid #ff5a00', padding: '2rem', borderRadius: '1rem' }}>
                      <h1 style={{ fontSize: '24px', color: '#ff5a00' }}>Ocorreu um Erro Crítico na Inicialização</h1>
                      <pre style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-all', marginTop: '10px', color: '#d0d2d6' }}>
                          {error.toString()}
                      </pre>
                       <p style={{marginTop: '1rem', color: '#a0a4b1'}}>Isso pode ter acontecido porque o Firebase não conseguiu carregar a tempo. Tente atualizar a página. Se o problema persistir, verifique a conexão com a internet ou as configurações do Firebase no código.</p>
                  </div>
              </div>
          );
      };

      const startApp = async () => {
          try {
              // Show a simple loading indicator before React mounts
              document.getElementById("root").innerHTML = `
                  <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background-color: #1a2035;">
                      <svg class="animate-spin h-12 w-12 text-tecnoit-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="width: 3rem; height: 3rem; color: #ff5a00;">
                          <path d="M21 12a9 9 0 1 1-6.219-8.56" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
                      </svg>
                  </div>`;
              await initFirebase();
              const root = ReactDOM.createRoot(document.getElementById("root"));
              root.render(<App />);
          } catch (error) {
              console.error("Falha na inicialização do app:", error);
              renderError(error);
          }
      };
      
      // A robust way to ensure Firebase is ready before starting the app.
      function ensureFirebaseIsReady(callback, timeout = 8000) {
          const startTime = Date.now();
          const interval = setInterval(() => {
              // Check for specific functions to be available on the window.firebase object
              if (typeof window.firebase !== 'undefined' && 
                  typeof window.firebase.initializeApp === 'function' && 
                  typeof window.firebase.getAuth === 'function' && 
                  typeof window.firebase.getFirestore === 'function') {
                  
                  clearInterval(interval);
                  callback(); // Firebase is ready, proceed with the app start
              } else if (Date.now() - startTime > timeout) {
                  // If it takes too long, stop checking and show an error
                  clearInterval(interval);
                  renderError(new Error("Timeout: O SDK do Firebase demorou muito para carregar. Verifique sua conexão com a internet ou possíveis bloqueadores de script."));
              }
          }, 100); // Check every 100ms
      }

      // Start the initialization process.
      ensureFirebaseIsReady(startApp);

  </script>
</body>

</html>

